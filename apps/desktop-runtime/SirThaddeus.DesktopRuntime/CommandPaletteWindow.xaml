<Window x:Class="SirThaddeus.DesktopRuntime.CommandPaletteWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:conv="clr-namespace:SirThaddeus.DesktopRuntime.Converters"
        Title="Chat"
        Width="960"
        Height="640"
        MinWidth="640"
        MinHeight="400"
        WindowStartupLocation="CenterScreen"
        WindowStyle="SingleBorderWindow"
        ResizeMode="CanResize"
        Background="#1E1E2E"
        Foreground="#CDD6F4"
        KeyDown="Window_KeyDown">

    <Window.Resources>
        <!-- ── Catppuccin Mocha Palette ────────────────────────────── -->
        <SolidColorBrush x:Key="BaseBrush"     Color="#1E1E2E"/>
        <SolidColorBrush x:Key="MantleBrush"   Color="#181825"/>
        <SolidColorBrush x:Key="CrustBrush"    Color="#11111B"/>
        <SolidColorBrush x:Key="Surface0Brush" Color="#313244"/>
        <SolidColorBrush x:Key="Surface1Brush" Color="#45475A"/>
        <SolidColorBrush x:Key="Surface2Brush" Color="#585B70"/>
        <SolidColorBrush x:Key="Overlay0Brush" Color="#6C7086"/>
        <SolidColorBrush x:Key="Subtext0Brush" Color="#A6ADC8"/>
        <SolidColorBrush x:Key="TextBrush"     Color="#CDD6F4"/>
        <SolidColorBrush x:Key="BlueBrush"     Color="#89B4FA"/>
        <SolidColorBrush x:Key="GreenBrush"    Color="#A6E3A1"/>
        <SolidColorBrush x:Key="RedBrush"      Color="#F38BA8"/>
        <SolidColorBrush x:Key="YellowBrush"   Color="#F9E2AF"/>
        <SolidColorBrush x:Key="MauveBrush"    Color="#CBA6F7"/>
        <SolidColorBrush x:Key="PeachBrush"    Color="#FAB387"/>
        <SolidColorBrush x:Key="TealBrush"     Color="#94E2D5"/>

        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
        <conv:Base64ToImageConverter  x:Key="Base64ToImage"/>
        <conv:StringToBrushConverter  x:Key="StringToBrush"/>
        <conv:UrlToImageConverter     x:Key="UrlToImage"/>
        <conv:MarkdownToFlowDocumentConverter x:Key="MarkdownToFlowDocument"/>

        <!-- ── Chat Input TextBox ──────────────────────────────────── -->
        <Style x:Key="ChatInputStyle" TargetType="TextBox">
            <Setter Property="Background"              Value="{StaticResource Surface0Brush}"/>
            <Setter Property="Foreground"              Value="{StaticResource TextBrush}"/>
            <Setter Property="CaretBrush"              Value="{StaticResource BlueBrush}"/>
            <Setter Property="BorderBrush"             Value="{StaticResource Surface1Brush}"/>
            <Setter Property="BorderThickness"         Value="1"/>
            <Setter Property="Padding"                 Value="12,10"/>
            <Setter Property="FontSize"                Value="14"/>
            <Setter Property="FontFamily"              Value="Segoe UI, sans-serif"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Setter Property="SelectionBrush"          Value="{StaticResource BlueBrush}"/>
            <Style.Triggers>
                <Trigger Property="IsFocused" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource BlueBrush}"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <!-- ── Send Button ─────────────────────────────────────────── -->
        <Style x:Key="SendButtonStyle" TargetType="Button">
            <Setter Property="Background"     Value="{StaticResource BlueBrush}"/>
            <Setter Property="Foreground"     Value="{StaticResource CrustBrush}"/>
            <Setter Property="FontWeight"     Value="SemiBold"/>
            <Setter Property="FontSize"       Value="13"/>
            <Setter Property="Padding"        Value="16,10"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor"         Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="Bd"
                                Background="{TemplateBinding Background}"
                                CornerRadius="8"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center"
                                              VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="#74C7EC"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="Bd" Property="Background"
                                        Value="{StaticResource Surface1Brush}"/>
                                <Setter Property="Foreground"
                                        Value="{StaticResource Overlay0Brush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- ── Cancel Button ───────────────────────────────────────── -->
        <Style x:Key="CancelButtonStyle" TargetType="Button">
            <Setter Property="Background"     Value="{StaticResource RedBrush}"/>
            <Setter Property="Foreground"     Value="{StaticResource CrustBrush}"/>
            <Setter Property="FontWeight"     Value="SemiBold"/>
            <Setter Property="FontSize"       Value="13"/>
            <Setter Property="Padding"        Value="16,10"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor"         Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="Bd"
                                Background="{TemplateBinding Background}"
                                CornerRadius="8"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center"
                                              VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="#EBA0AC"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- ── View Tab Toggle (Chat / Memory) ───────────────────────── -->
        <Style x:Key="ViewTabStyle" TargetType="ToggleButton">
            <Setter Property="Background"      Value="Transparent"/>
            <Setter Property="Foreground"      Value="{StaticResource Overlay0Brush}"/>
            <Setter Property="FontSize"        Value="12"/>
            <Setter Property="FontWeight"      Value="SemiBold"/>
            <Setter Property="Padding"         Value="12,5"/>
            <Setter Property="BorderThickness" Value="0,0,0,2"/>
            <Setter Property="BorderBrush"     Value="Transparent"/>
            <Setter Property="Cursor"          Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Border x:Name="Bd"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center"
                                              VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter Property="Foreground" Value="{StaticResource BlueBrush}"/>
                                <Setter TargetName="Bd" Property="BorderBrush"
                                        Value="{StaticResource BlueBrush}"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bd" Property="Background"
                                        Value="{StaticResource Surface0Brush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- ── Memory DataGrid Styles ────────────────────────────────── -->
        <Style x:Key="MemoryDataGridStyle" TargetType="DataGrid">
            <Setter Property="Background"              Value="{StaticResource BaseBrush}"/>
            <Setter Property="Foreground"              Value="{StaticResource TextBrush}"/>
            <Setter Property="BorderThickness"         Value="0"/>
            <Setter Property="RowBackground"           Value="{StaticResource BaseBrush}"/>
            <Setter Property="AlternatingRowBackground" Value="{StaticResource MantleBrush}"/>
            <Setter Property="GridLinesVisibility"     Value="Horizontal"/>
            <Setter Property="HorizontalGridLinesBrush" Value="{StaticResource Surface0Brush}"/>
            <Setter Property="HeadersVisibility"       Value="Column"/>
            <Setter Property="AutoGenerateColumns"     Value="False"/>
            <Setter Property="CanUserAddRows"          Value="False"/>
            <Setter Property="CanUserDeleteRows"       Value="False"/>
            <Setter Property="CanUserResizeRows"       Value="False"/>
            <Setter Property="CanUserSortColumns"      Value="True"/>
            <Setter Property="SelectionMode"           Value="Single"/>
            <Setter Property="FontSize"                Value="12"/>
            <Setter Property="FontFamily"              Value="Segoe UI, sans-serif"/>
            <Setter Property="RowHeight"               Value="32"/>
        </Style>

        <Style x:Key="MemoryColumnHeaderStyle" TargetType="DataGridColumnHeader">
            <Setter Property="Background"      Value="{StaticResource CrustBrush}"/>
            <Setter Property="Foreground"      Value="{StaticResource Subtext0Brush}"/>
            <Setter Property="FontSize"        Value="11"/>
            <Setter Property="FontWeight"      Value="SemiBold"/>
            <Setter Property="Padding"         Value="8,6"/>
            <Setter Property="BorderBrush"     Value="{StaticResource Surface0Brush}"/>
            <Setter Property="BorderThickness" Value="0,0,1,1"/>
        </Style>

        <Style x:Key="MemoryDataGridCellStyle" TargetType="DataGridCell">
            <Setter Property="Foreground" Value="{StaticResource TextBrush}"/>
            <Setter Property="Padding"    Value="6,4"/>
            <Setter Property="BorderBrush"     Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="DataGridCell">
                        <Border Background="{TemplateBinding Background}"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsSelected" Value="True">
                    <Setter Property="Background" Value="{StaticResource Surface0Brush}"/>
                    <Setter Property="Foreground" Value="{StaticResource TextBrush}"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="MemoryDataGridRowStyle" TargetType="DataGridRow">
            <Setter Property="Foreground" Value="{StaticResource TextBrush}"/>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="{StaticResource Surface0Brush}"/>
                </Trigger>
                <Trigger Property="IsSelected" Value="True">
                    <Setter Property="Background" Value="{StaticResource Surface0Brush}"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <!-- ── Memory Sub-tab Button ─────────────────────────────────── -->
        <Style x:Key="MemorySubTabStyle" TargetType="RadioButton">
            <Setter Property="Background"      Value="Transparent"/>
            <Setter Property="Foreground"      Value="{StaticResource Overlay0Brush}"/>
            <Setter Property="FontSize"        Value="11"/>
            <Setter Property="FontWeight"      Value="SemiBold"/>
            <Setter Property="Padding"         Value="10,5"/>
            <Setter Property="Cursor"          Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="RadioButton">
                        <Border x:Name="Bd"
                                Background="{TemplateBinding Background}"
                                CornerRadius="4"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center"
                                              VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter Property="Foreground" Value="{StaticResource TextBrush}"/>
                                <Setter TargetName="Bd" Property="Background"
                                        Value="{StaticResource Surface0Brush}"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bd" Property="Background"
                                        Value="{StaticResource Surface0Brush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- ── Memory Action Button ──────────────────────────────────── -->
        <Style x:Key="MemoryActionButtonStyle" TargetType="Button">
            <Setter Property="Background"      Value="{StaticResource Surface0Brush}"/>
            <Setter Property="Foreground"      Value="{StaticResource TextBrush}"/>
            <Setter Property="FontSize"        Value="11"/>
            <Setter Property="Padding"         Value="10,5"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor"          Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="Bd"
                                Background="{TemplateBinding Background}"
                                CornerRadius="4"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center"
                                              VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bd" Property="Background"
                                        Value="{StaticResource Surface1Brush}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Foreground"
                                        Value="{StaticResource Overlay0Brush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="MemoryDeleteButtonStyle" TargetType="Button"
               BasedOn="{StaticResource MemoryActionButtonStyle}">
            <Setter Property="Foreground" Value="{StaticResource RedBrush}"/>
        </Style>

        <!-- ── ComboBox Toggle Button (internal) ───────────────────── -->
        <ControlTemplate x:Key="ComboBoxToggleTemplate" TargetType="ToggleButton">
            <Border x:Name="Bd"
                    Background="{StaticResource Surface0Brush}"
                    BorderBrush="{StaticResource Surface1Brush}"
                    BorderThickness="1"
                    CornerRadius="6"
                    SnapsToDevicePixels="True">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="32"/>
                    </Grid.ColumnDefinitions>
                    <Border Grid.Column="1" Background="Transparent">
                        <Path Data="M0,0 L4,4 L8,0"
                              Stroke="{StaticResource Subtext0Brush}"
                              StrokeThickness="1.5"
                              Fill="Transparent"
                              HorizontalAlignment="Center"
                              VerticalAlignment="Center"/>
                    </Border>
                </Grid>
            </Border>
            <ControlTemplate.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter TargetName="Bd" Property="BorderBrush"
                            Value="{StaticResource BlueBrush}"/>
                </Trigger>
                <Trigger Property="IsChecked" Value="True">
                    <Setter TargetName="Bd" Property="BorderBrush"
                            Value="{StaticResource BlueBrush}"/>
                </Trigger>
            </ControlTemplate.Triggers>
        </ControlTemplate>

        <!-- ── ComboBox (Catppuccin Dark) ────────────────────────────── -->
        <Style x:Key="DarkComboBoxStyle" TargetType="ComboBox">
            <Setter Property="Foreground"          Value="{StaticResource TextBrush}"/>
            <Setter Property="FontSize"            Value="13"/>
            <Setter Property="FontFamily"          Value="Segoe UI, sans-serif"/>
            <Setter Property="SnapsToDevicePixels" Value="True"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ComboBox">
                        <Grid>
                            <ToggleButton x:Name="ToggleButton"
                                          Template="{StaticResource ComboBoxToggleTemplate}"
                                          IsChecked="{Binding IsDropDownOpen, Mode=TwoWay,
                                                      RelativeSource={RelativeSource TemplatedParent}}"
                                          Focusable="False"
                                          ClickMode="Press"/>
                            <ContentPresenter x:Name="ContentSite"
                                              IsHitTestVisible="False"
                                              Content="{TemplateBinding SelectionBoxItem}"
                                              ContentTemplate="{TemplateBinding SelectionBoxItemTemplate}"
                                              ContentStringFormat="{TemplateBinding SelectionBoxItemStringFormat}"
                                              Margin="12,8,32,8"
                                              VerticalAlignment="Center"
                                              HorizontalAlignment="Left"/>
                            <Popup x:Name="Popup"
                                   IsOpen="{TemplateBinding IsDropDownOpen}"
                                   Placement="Bottom"
                                   AllowsTransparency="True"
                                   PopupAnimation="Slide"
                                   Focusable="False">
                                <Grid x:Name="DropDown"
                                      MinWidth="{TemplateBinding ActualWidth}"
                                      MaxHeight="{TemplateBinding MaxDropDownHeight}"
                                      SnapsToDevicePixels="True">
                                    <Border Background="{StaticResource MantleBrush}"
                                            BorderBrush="{StaticResource Surface1Brush}"
                                            BorderThickness="1"
                                            CornerRadius="6"
                                            Margin="0,2,0,0"
                                            Padding="0,4">
                                        <ScrollViewer SnapsToDevicePixels="True">
                                            <ItemsPresenter KeyboardNavigation.DirectionalNavigation="Contained"/>
                                        </ScrollViewer>
                                    </Border>
                                </Grid>
                            </Popup>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- ── ComboBox Item (Catppuccin Dark) ───────────────────────── -->
        <Style x:Key="DarkComboBoxItemStyle" TargetType="ComboBoxItem">
            <Setter Property="Background"  Value="Transparent"/>
            <Setter Property="Foreground"  Value="{StaticResource TextBrush}"/>
            <Setter Property="Padding"     Value="12,8"/>
            <Setter Property="Cursor"      Value="Hand"/>
            <Setter Property="FontSize"    Value="13"/>
            <Setter Property="FontFamily"  Value="Segoe UI, sans-serif"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ComboBoxItem">
                        <Border x:Name="Bd"
                                Background="{TemplateBinding Background}"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsHighlighted" Value="True">
                                <Setter TargetName="Bd" Property="Background"
                                        Value="{StaticResource Surface0Brush}"/>
                            </Trigger>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter TargetName="Bd" Property="Background"
                                        Value="{StaticResource Surface1Brush}"/>
                                <Setter Property="Foreground"
                                        Value="{StaticResource BlueBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- ── Header Button (New Chat) ────────────────────────────── -->
        <Style x:Key="HeaderButtonStyle" TargetType="Button">
            <Setter Property="Background"     Value="Transparent"/>
            <Setter Property="Foreground"     Value="{StaticResource Subtext0Brush}"/>
            <Setter Property="FontSize"       Value="12"/>
            <Setter Property="Padding"        Value="10,5"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor"         Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="Bd"
                                Background="{TemplateBinding Background}"
                                CornerRadius="4"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center"
                                              VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bd" Property="Background"
                                        Value="{StaticResource Surface0Brush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="HeaderToggleButtonStyle" TargetType="ToggleButton">
            <Setter Property="Background"      Value="Transparent"/>
            <Setter Property="Foreground"      Value="{StaticResource Subtext0Brush}"/>
            <Setter Property="FontSize"        Value="12"/>
            <Setter Property="Padding"         Value="10,5"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor"          Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Border x:Name="Bd"
                                Background="{TemplateBinding Background}"
                                CornerRadius="4"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center"
                                              VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bd" Property="Background"
                                        Value="{StaticResource Surface0Brush}"/>
                            </Trigger>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="Bd" Property="Background"
                                        Value="{StaticResource Surface1Brush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>  <!-- Header -->
            <RowDefinition Height="*"/>     <!-- Content (split) -->
            <RowDefinition Height="Auto"/>  <!-- Input -->
        </Grid.RowDefinitions>

        <!-- ═══════════════════════════════════════════════════════════
             HEADER
             ═══════════════════════════════════════════════════════ -->
        <Border Grid.Row="0"
                Background="{StaticResource MantleBrush}"
                Padding="16,10"
                BorderBrush="{StaticResource Surface0Brush}"
                BorderThickness="0,0,0,1">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Connection indicator -->
                <StackPanel Grid.Column="0"
                            Orientation="Horizontal"
                            VerticalAlignment="Center"
                            Margin="0,0,16,0">
                    <Ellipse Width="8" Height="8"
                             Margin="0,0,8,0"
                             VerticalAlignment="Center">
                        <Ellipse.Style>
                            <Style TargetType="Ellipse">
                                <Setter Property="Fill" Value="{StaticResource RedBrush}"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsLlmConnected}" Value="True">
                                        <Setter Property="Fill" Value="{StaticResource GreenBrush}"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Ellipse.Style>
                    </Ellipse>
                    <TextBlock Text="{Binding ConnectionStatus}"
                               FontSize="12"
                               Foreground="{StaticResource Subtext0Brush}"
                               VerticalAlignment="Center"/>
                </StackPanel>

                <!-- View toggle tabs -->
                <StackPanel Grid.Column="1"
                            Orientation="Horizontal"
                            VerticalAlignment="Center">
                    <ToggleButton x:Name="ChatTabButton"
                                  Content="Chat"
                                  IsChecked="True"
                                  Click="ChatTab_Click"
                                  Style="{StaticResource ViewTabStyle}"/>
                    <ToggleButton x:Name="MemoryTabButton"
                                  Content="Memory"
                                  IsChecked="False"
                                  Click="MemoryTab_Click"
                                  Style="{StaticResource ViewTabStyle}"/>
                    <ToggleButton x:Name="ProfileTabButton"
                                  Content="Profile"
                                  IsChecked="False"
                                  Click="ProfileTab_Click"
                                  Style="{StaticResource ViewTabStyle}"/>
                    <ToggleButton x:Name="SettingsTabButton"
                                  Content="⚙ Settings"
                                  IsChecked="False"
                                  Click="SettingsTab_Click"
                                  Style="{StaticResource ViewTabStyle}"/>
                </StackPanel>

                <!-- Token usage ticker -->
                <Border Grid.Column="2"
                        HorizontalAlignment="Right"
                        VerticalAlignment="Center"
                        Margin="16,0,12,0"
                        Padding="8,4"
                        Background="{StaticResource Surface0Brush}"
                        CornerRadius="8">
                    <StackPanel Orientation="Horizontal"
                                VerticalAlignment="Center">
                        <TextBlock Text="In "
                                   FontSize="11"
                                   Foreground="{StaticResource Overlay0Brush}"/>
                        <TextBlock Text="{Binding TokensIn}"
                                   FontSize="11"
                                   FontWeight="SemiBold"
                                   Foreground="{StaticResource Subtext0Brush}"/>
                        <TextBlock Text="  Out "
                                   Margin="10,0,0,0"
                                   FontSize="11"
                                   Foreground="{StaticResource Overlay0Brush}"/>
                        <TextBlock Text="{Binding TokensOut}"
                                   FontSize="11"
                                   FontWeight="SemiBold"
                                   Foreground="{StaticResource Subtext0Brush}"/>
                        <TextBlock Text="  Ctx "
                                   Margin="10,0,0,0"
                                   FontSize="11"
                                   Foreground="{StaticResource Overlay0Brush}"/>
                        <TextBlock Text="{Binding ContextFillPercent}"
                                   FontSize="11"
                                   FontWeight="SemiBold"
                                   Foreground="{StaticResource Subtext0Brush}"/>
                        <TextBlock Text="%"
                                   FontSize="11"
                                   Foreground="{StaticResource Subtext0Brush}"/>
                    </StackPanel>
                </Border>

                <!-- Context lock -->
                <ToggleButton Grid.Column="3"
                              Content="Lock Context"
                              IsChecked="{Binding ContextLocked, Mode=TwoWay}"
                              Style="{StaticResource HeaderToggleButtonStyle}"
                              Margin="0,0,8,0"/>

                <!-- New Chat (only visible in Chat mode) -->
                <Button Grid.Column="4"
                        x:Name="NewChatButton"
                        Content="New Chat"
                        Command="{Binding ClearCommand}"
                        Style="{StaticResource HeaderButtonStyle}"/>
            </Grid>
        </Border>

        <!-- ═══════════════════════════════════════════════════════════
             CONTENT — SPLIT PANE (Chat | Activity Log)
             ═══════════════════════════════════════════════════════ -->
        <Grid Grid.Row="1" x:Name="ChatView">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="3*"  MinWidth="260"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="2*"  MinWidth="200"/>
            </Grid.ColumnDefinitions>

            <!-- ── Left: Chat Messages ─────────────────────────────── -->
            <ScrollViewer Grid.Column="0"
                          x:Name="ChatScroller"
                          Background="{StaticResource BaseBrush}"
                          VerticalScrollBarVisibility="Auto"
                          HorizontalScrollBarVisibility="Disabled">
                <ItemsControl ItemsSource="{Binding Messages}"
                              Padding="12,8">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Grid Margin="0,3">
                                <Border x:Name="Bubble"
                                        CornerRadius="12"
                                        Padding="14,10"
                                        MaxWidth="480"
                                        HorizontalAlignment="Left"
                                        Background="{StaticResource Surface0Brush}">
                                    <StackPanel>
                                        <TextBlock x:Name="TimeLabel"
                                                   Text="{Binding TimeDisplay}"
                                                   FontSize="10"
                                                   Foreground="{StaticResource Overlay0Brush}"
                                                   Margin="0,0,0,3"/>
                                        <Border x:Name="ThinkingPanel"
                                                Visibility="Collapsed"
                                                Margin="0,0,0,8"
                                                Background="#3322283A"
                                                BorderBrush="{StaticResource Surface1Brush}"
                                                BorderThickness="1"
                                                CornerRadius="8"
                                                Padding="8,6">
                                            <Expander IsExpanded="{Binding IsThoughtExpanded, Mode=TwoWay}"
                                                      Background="Transparent"
                                                      BorderThickness="0"
                                                      Foreground="{StaticResource Subtext0Brush}">
                                                <Expander.Header>
                                                    <TextBlock Text="Model thinking"
                                                               FontSize="11"
                                                               FontWeight="SemiBold"
                                                               Foreground="{StaticResource Subtext0Brush}"/>
                                                </Expander.Header>
                                                <TextBox Text="{Binding ThoughtContent, Mode=OneWay}"
                                                         Margin="0,6,0,0"
                                                         TextWrapping="Wrap"
                                                         FontSize="12"
                                                         FontFamily="Consolas, Cascadia Mono, monospace"
                                                         Foreground="{StaticResource Overlay0Brush}"
                                                         Background="Transparent"
                                                         BorderThickness="0"
                                                         Padding="0"
                                                         IsReadOnly="True"
                                                         IsReadOnlyCaretVisible="False"
                                                         IsTabStop="False"
                                                         FocusVisualStyle="{x:Null}"
                                                         Cursor="IBeam"
                                                         SelectionBrush="{StaticResource BlueBrush}"
                                                         SelectionOpacity="0.35"
                                                         CaretBrush="{StaticResource TextBrush}"/>
                                            </Expander>
                                        </Border>
                                        <!--
                                            Message body
                                            - Default: lightweight Markdown-ish rendering (bold + bullets) via FlowDocument.
                                            - Tool/status messages: fall back to plain TextBox for tight control over styling.
                                        -->
                                        <FlowDocumentScrollViewer x:Name="ContentMarkdown"
                                                                 Document="{Binding Content, Converter={StaticResource MarkdownToFlowDocument}}"
                                                                 FontSize="13"
                                                                 FontFamily="Segoe UI"
                                                                 Foreground="{StaticResource TextBrush}"
                                                                 Background="Transparent"
                                                                 FocusVisualStyle="{x:Null}"
                                                                 IsTabStop="False"
                                                                 IsSelectionEnabled="True"
                                                                 VerticalScrollBarVisibility="Hidden"
                                                                 HorizontalScrollBarVisibility="Hidden"/>

                                        <TextBox x:Name="ContentPlain"
                                                 Text="{Binding Content, Mode=OneWay}"
                                                 Visibility="Collapsed"
                                                 TextWrapping="Wrap"
                                                 FontSize="13"
                                                 FontFamily="Segoe UI"
                                                 Foreground="{StaticResource TextBrush}"
                                                 Background="Transparent"
                                                 BorderThickness="0"
                                                 Padding="0"
                                                 IsReadOnly="True"
                                                 IsReadOnlyCaretVisible="False"
                                                 IsTabStop="False"
                                                 FocusVisualStyle="{x:Null}"
                                                 Cursor="IBeam"
                                                 SelectionBrush="{StaticResource BlueBrush}"
                                                 SelectionOpacity="0.35"
                                                 CaretBrush="{StaticResource TextBrush}"/>

                                        <!-- ══════════════════════════════════════
                                             SOURCE CARDS CAROUSEL
                                             ViewModel-driven paging — shows 2
                                             cards at a time, arrows swap pages.
                                             No ScrollViewer, no jank.
                                             ══════════════════════════════════ -->
                                        <Grid x:Name="SourceCardsPanel"
                                              Visibility="Collapsed"
                                              Margin="0,12,0,4">
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                            </Grid.RowDefinitions>

                                            <!-- ── Left arrow (overlaid) ──────── -->
                                            <Button Grid.Row="0"
                                                    Command="{Binding PrevPageCommand}"
                                                    VerticalAlignment="Center"
                                                    HorizontalAlignment="Left"
                                                    Panel.ZIndex="10"
                                                    Cursor="Hand"
                                                    Width="30" Height="30"
                                                    Margin="-4,0,0,0">
                                                <Button.Style>
                                                    <Style TargetType="Button">
                                                        <Setter Property="Visibility" Value="Visible"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding CanGoLeft}" Value="False">
                                                                <Setter Property="Visibility" Value="Hidden"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Button.Style>
                                                <Button.Template>
                                                    <ControlTemplate TargetType="Button">
                                                        <Border x:Name="ArrowBg"
                                                                Background="#DD1E1E2E"
                                                                CornerRadius="15"
                                                                Width="30" Height="30">
                                                            <TextBlock Text="&#x276E;"
                                                                       FontSize="14"
                                                                       Foreground="{StaticResource TextBrush}"
                                                                       HorizontalAlignment="Center"
                                                                       VerticalAlignment="Center"/>
                                                        </Border>
                                                        <ControlTemplate.Triggers>
                                                            <Trigger Property="IsMouseOver" Value="True">
                                                                <Setter TargetName="ArrowBg"
                                                                        Property="Background" Value="#EE45475A"/>
                                                            </Trigger>
                                                        </ControlTemplate.Triggers>
                                                    </ControlTemplate>
                                                </Button.Template>
                                            </Button>

                                            <!-- ── Right arrow (overlaid) ─────── -->
                                            <Button Grid.Row="0"
                                                    Command="{Binding NextPageCommand}"
                                                    VerticalAlignment="Center"
                                                    HorizontalAlignment="Right"
                                                    Panel.ZIndex="10"
                                                    Cursor="Hand"
                                                    Width="30" Height="30"
                                                    Margin="0,0,-4,0">
                                                <Button.Style>
                                                    <Style TargetType="Button">
                                                        <Setter Property="Visibility" Value="Visible"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding CanGoRight}" Value="False">
                                                                <Setter Property="Visibility" Value="Hidden"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Button.Style>
                                                <Button.Template>
                                                    <ControlTemplate TargetType="Button">
                                                        <Border x:Name="ArrowBg"
                                                                Background="#DD1E1E2E"
                                                                CornerRadius="15"
                                                                Width="30" Height="30">
                                                            <TextBlock Text="&#x276F;"
                                                                       FontSize="14"
                                                                       Foreground="{StaticResource TextBrush}"
                                                                       HorizontalAlignment="Center"
                                                                       VerticalAlignment="Center"/>
                                                        </Border>
                                                        <ControlTemplate.Triggers>
                                                            <Trigger Property="IsMouseOver" Value="True">
                                                                <Setter TargetName="ArrowBg"
                                                                        Property="Background" Value="#EE45475A"/>
                                                            </Trigger>
                                                        </ControlTemplate.Triggers>
                                                    </ControlTemplate>
                                                </Button.Template>
                                            </Button>

                                            <!-- ── Card row (2 per page, ViewModel-driven) ── -->
                                            <ItemsControl Grid.Row="0"
                                                          ItemsSource="{Binding VisibleCards}"
                                                          Margin="10,0,10,0">
                                                <ItemsControl.ItemsPanel>
                                                    <ItemsPanelTemplate>
                                                        <StackPanel Orientation="Horizontal"/>
                                                    </ItemsPanelTemplate>
                                                </ItemsControl.ItemsPanel>
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <!-- ── Clickable Source Card ────── -->
                                                        <Button Click="SourceCard_Click"
                                                                Cursor="Hand"
                                                                Margin="0,0,10,0"
                                                                VerticalAlignment="Top"
                                                                Opacity="0"
                                                                RenderTransformOrigin="0,0.5">
                                                            <!-- Slide+fade entrance on page swap -->
                                                            <Button.RenderTransform>
                                                                <TranslateTransform/>
                                                            </Button.RenderTransform>
                                                            <Button.Triggers>
                                                                <EventTrigger RoutedEvent="FrameworkElement.Loaded">
                                                                    <BeginStoryboard>
                                                                        <Storyboard>
                                                                            <DoubleAnimation
                                                                                Storyboard.TargetProperty="Opacity"
                                                                                From="0" To="1"
                                                                                Duration="0:0:0.28"/>
                                                                            <DoubleAnimation
                                                                                Storyboard.TargetProperty="(UIElement.RenderTransform).(TranslateTransform.X)"
                                                                                From="40" To="0"
                                                                                Duration="0:0:0.3">
                                                                                <DoubleAnimation.EasingFunction>
                                                                                    <CubicEase EasingMode="EaseOut"/>
                                                                                </DoubleAnimation.EasingFunction>
                                                                            </DoubleAnimation>
                                                                        </Storyboard>
                                                                    </BeginStoryboard>
                                                                </EventTrigger>
                                                            </Button.Triggers>
                                                            <Button.Template>
                                                                <ControlTemplate TargetType="Button">
                                                                    <Border x:Name="CardBorder"
                                                                            Background="{StaticResource Surface1Brush}"
                                                                            CornerRadius="10"
                                                                            Width="198"
                                                                            ClipToBounds="True"
                                                                            SnapsToDevicePixels="True">
                                                                        <StackPanel>
                                                                            <!-- ── Thumbnail image area ──── -->
                                                                            <Grid Height="110"
                                                                                  Background="{StaticResource Surface0Brush}">
                                                                                <Image x:Name="ThumbnailImg"
                                                                                       Source="{Binding ThumbnailUrl,
                                                                                                Converter={StaticResource UrlToImage}}"
                                                                                       Stretch="UniformToFill"
                                                                                       HorizontalAlignment="Center"
                                                                                       VerticalAlignment="Center"
                                                                                       Visibility="Collapsed"/>

                                                                                <Border x:Name="ThumbPlaceholder"
                                                                                        Background="{Binding AvatarColor,
                                                                                                     Converter={StaticResource StringToBrush}}">
                                                                                    <TextBlock Text="{Binding AvatarLetter}"
                                                                                               FontSize="32"
                                                                                               FontWeight="Bold"
                                                                                               Foreground="#11111B"
                                                                                               Opacity="0.35"
                                                                                               HorizontalAlignment="Center"
                                                                                               VerticalAlignment="Center"/>
                                                                                </Border>
                                                                            </Grid>

                                                                            <!-- ── Card body ──────────────── -->
                                                                            <StackPanel Margin="12,8,12,10">
                                                                                <!-- Domain + favicon row -->
                                                                                <Grid Height="18" Margin="0,0,0,5">
                                                                                    <Grid.ColumnDefinitions>
                                                                                        <ColumnDefinition Width="18"/>
                                                                                        <ColumnDefinition Width="*"/>
                                                                                    </Grid.ColumnDefinitions>

                                                                                    <Image x:Name="FaviconImg"
                                                                                           Grid.Column="0"
                                                                                           Source="{Binding FaviconBase64,
                                                                                                    Converter={StaticResource Base64ToImage}}"
                                                                                           Width="14" Height="14"
                                                                                           HorizontalAlignment="Center"
                                                                                           VerticalAlignment="Center"
                                                                                           Visibility="Collapsed"/>

                                                                                    <Border x:Name="AvatarCircle"
                                                                                            Grid.Column="0"
                                                                                            Width="16" Height="16"
                                                                                            CornerRadius="8"
                                                                                            HorizontalAlignment="Center"
                                                                                            VerticalAlignment="Center"
                                                                                            Background="{Binding AvatarColor,
                                                                                                         Converter={StaticResource StringToBrush}}">
                                                                                        <TextBlock Text="{Binding AvatarLetter}"
                                                                                                   FontSize="8"
                                                                                                   FontWeight="Bold"
                                                                                                   Foreground="#11111B"
                                                                                                   HorizontalAlignment="Center"
                                                                                                   VerticalAlignment="Center"/>
                                                                                    </Border>

                                                                                    <TextBlock Grid.Column="1"
                                                                                               Text="{Binding Domain}"
                                                                                               FontSize="10.5"
                                                                                               Foreground="{StaticResource Overlay0Brush}"
                                                                                               VerticalAlignment="Center"
                                                                                               Margin="5,0,0,0"
                                                                                               TextTrimming="CharacterEllipsis"/>
                                                                                </Grid>

                                                                                <!-- Title -->
                                                                                <TextBlock Text="{Binding Title}"
                                                                                           FontSize="12.5"
                                                                                           FontWeight="SemiBold"
                                                                                           Foreground="{StaticResource TextBrush}"
                                                                                           TextWrapping="Wrap"
                                                                                           MaxHeight="36"
                                                                                           TextTrimming="CharacterEllipsis"
                                                                                           Margin="0,0,0,4"/>

                                                                                <!-- Excerpt / summary -->
                                                                                <TextBlock Text="{Binding Excerpt}"
                                                                                           FontSize="11"
                                                                                           Foreground="{StaticResource Subtext0Brush}"
                                                                                           TextWrapping="Wrap"
                                                                                           MaxHeight="64"
                                                                                           TextTrimming="CharacterEllipsis"
                                                                                           LineHeight="15"/>
                                                                            </StackPanel>
                                                                        </StackPanel>
                                                                    </Border>

                                                                    <ControlTemplate.Triggers>
                                                                        <Trigger Property="IsMouseOver" Value="True">
                                                                            <Setter TargetName="CardBorder"
                                                                                    Property="Background"
                                                                                    Value="{StaticResource Surface2Brush}"/>
                                                                        </Trigger>
                                                                        <DataTrigger Binding="{Binding HasThumbnail}" Value="True">
                                                                            <Setter TargetName="ThumbnailImg"
                                                                                    Property="Visibility" Value="Visible"/>
                                                                            <Setter TargetName="ThumbPlaceholder"
                                                                                    Property="Visibility" Value="Collapsed"/>
                                                                        </DataTrigger>
                                                                        <DataTrigger Binding="{Binding HasFavicon}" Value="True">
                                                                            <Setter TargetName="FaviconImg"
                                                                                    Property="Visibility" Value="Visible"/>
                                                                            <Setter TargetName="AvatarCircle"
                                                                                    Property="Visibility" Value="Collapsed"/>
                                                                        </DataTrigger>
                                                                    </ControlTemplate.Triggers>
                                                                </ControlTemplate>
                                                            </Button.Template>
                                                        </Button>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>

                                            <!-- ── Page indicator (e.g. "1 / 3") ── -->
                                            <TextBlock Grid.Row="1"
                                                       Text="{Binding CarouselPageLabel}"
                                                       FontSize="11"
                                                       Foreground="{StaticResource Overlay0Brush}"
                                                       HorizontalAlignment="Center"
                                                       Margin="0,6,0,0"/>
                                        </Grid>
                                    </StackPanel>
                                </Border>
                            </Grid>

                            <DataTemplate.Triggers>
                                <!-- ── Show source cards when present ──────── -->
                                <DataTrigger Binding="{Binding HasSourceCards}" Value="True">
                                    <Setter TargetName="SourceCardsPanel"
                                            Property="Visibility" Value="Visible"/>
                                </DataTrigger>

                                <!-- ── Assistant thought traces (collapsed expander) ── -->
                                <DataTrigger Binding="{Binding HasThoughtContent}" Value="True">
                                    <Setter TargetName="ThinkingPanel"
                                            Property="Visibility" Value="Visible"/>
                                </DataTrigger>

                                <!-- ── User: right-aligned accent bubble ──── -->
                                <DataTrigger Binding="{Binding IsUser}" Value="True">
                                    <Setter TargetName="Bubble"
                                            Property="HorizontalAlignment" Value="Right"/>
                                    <Setter TargetName="Bubble"
                                            Property="Background"
                                            Value="{StaticResource BlueBrush}"/>
                                    <Setter TargetName="ContentMarkdown"
                                            Property="Foreground"
                                            Value="{StaticResource CrustBrush}"/>
                                    <Setter TargetName="ContentMarkdown"
                                            Property="FontWeight" Value="Medium"/>
                                    <Setter TargetName="ContentPlain"
                                            Property="Foreground"
                                            Value="{StaticResource CrustBrush}"/>
                                    <Setter TargetName="ContentPlain"
                                            Property="FontWeight" Value="Medium"/>
                                    <Setter TargetName="TimeLabel"
                                            Property="Foreground" Value="#45475A"/>
                                    <Setter TargetName="TimeLabel"
                                            Property="HorizontalAlignment" Value="Right"/>
                                    <Setter TargetName="SourceCardsPanel"
                                            Property="Visibility" Value="Collapsed"/>
                                    <Setter TargetName="ThinkingPanel"
                                            Property="Visibility" Value="Collapsed"/>
                                </DataTrigger>

                                <!-- ── Tool activity: subtle bordered ─────── -->
                                <DataTrigger Binding="{Binding IsToolActivity}" Value="True">
                                    <Setter TargetName="Bubble"
                                            Property="Background"
                                            Value="{StaticResource MantleBrush}"/>
                                    <Setter TargetName="Bubble"
                                            Property="BorderBrush"
                                            Value="{StaticResource Surface1Brush}"/>
                                    <Setter TargetName="Bubble"
                                            Property="BorderThickness" Value="1"/>
                                    <Setter TargetName="ContentMarkdown"
                                            Property="Visibility" Value="Collapsed"/>
                                    <Setter TargetName="ContentPlain"
                                            Property="Visibility" Value="Visible"/>
                                    <Setter TargetName="ContentPlain"
                                            Property="FontSize" Value="11"/>
                                    <Setter TargetName="ContentPlain"
                                            Property="Foreground"
                                            Value="{StaticResource Subtext0Brush}"/>
                                    <Setter TargetName="TimeLabel"
                                            Property="Visibility" Value="Collapsed"/>
                                    <Setter TargetName="SourceCardsPanel"
                                            Property="Visibility" Value="Collapsed"/>
                                    <Setter TargetName="ThinkingPanel"
                                            Property="Visibility" Value="Collapsed"/>
                                </DataTrigger>

                                <!-- ── Status: centered, no bubble ────────── -->
                                <DataTrigger Binding="{Binding IsStatus}" Value="True">
                                    <Setter TargetName="Bubble"
                                            Property="HorizontalAlignment" Value="Stretch"/>
                                    <Setter TargetName="Bubble"
                                            Property="Background" Value="Transparent"/>
                                    <Setter TargetName="Bubble"
                                            Property="MaxWidth" Value="9999"/>
                                    <Setter TargetName="ContentMarkdown"
                                            Property="Visibility" Value="Collapsed"/>
                                    <Setter TargetName="ContentPlain"
                                            Property="Visibility" Value="Visible"/>
                                    <Setter TargetName="ContentPlain"
                                            Property="HorizontalAlignment" Value="Center"/>
                                    <Setter TargetName="ContentPlain"
                                            Property="TextAlignment" Value="Center"/>
                                    <Setter TargetName="ContentPlain"
                                            Property="FontStyle" Value="Italic"/>
                                    <Setter TargetName="ContentPlain"
                                            Property="FontSize" Value="12"/>
                                    <Setter TargetName="ContentPlain"
                                            Property="Foreground"
                                            Value="{StaticResource Overlay0Brush}"/>
                                    <Setter TargetName="TimeLabel"
                                            Property="Visibility" Value="Collapsed"/>
                                    <Setter TargetName="SourceCardsPanel"
                                            Property="Visibility" Value="Collapsed"/>
                                    <Setter TargetName="ThinkingPanel"
                                            Property="Visibility" Value="Collapsed"/>
                                </DataTrigger>
                            </DataTemplate.Triggers>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>

            <!-- ── Splitter ────────────────────────────────────────── -->
            <GridSplitter Grid.Column="1"
                          Width="1"
                          Background="{StaticResource Surface0Brush}"
                          HorizontalAlignment="Center"
                          VerticalAlignment="Stretch"
                          ResizeBehavior="PreviousAndNext"/>

            <!-- ── Right: Activity Log ─────────────────────────────── -->
            <Grid Grid.Column="2"
                  Background="{StaticResource CrustBrush}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Log header -->
                <Border Grid.Row="0"
                        Background="{StaticResource CrustBrush}"
                        Padding="12,8"
                        BorderBrush="{StaticResource Surface0Brush}"
                        BorderThickness="0,0,0,1">
                    <TextBlock Text="Activity Log"
                               FontSize="11"
                               FontWeight="SemiBold"
                               Foreground="{StaticResource Overlay0Brush}"/>
                </Border>

                <!-- Log entries -->
                <ScrollViewer Grid.Row="1"
                              x:Name="LogScroller"
                              VerticalScrollBarVisibility="Auto"
                              HorizontalScrollBarVisibility="Disabled">
                    <ItemsControl ItemsSource="{Binding ActivityLog}"
                                  Padding="8,4">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Grid Margin="0,1">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>

                                    <!-- Timestamp -->
                                    <TextBlock Grid.Column="0"
                                               Text="{Binding TimeDisplay}"
                                               FontFamily="Cascadia Mono, Consolas, monospace"
                                               FontSize="10"
                                               Foreground="{StaticResource Surface2Brush}"
                                               Margin="0,0,8,0"
                                               VerticalAlignment="Top"/>

                                    <!-- Log text -->
                                    <TextBlock x:Name="LogText"
                                               Grid.Column="1"
                                               Text="{Binding Text}"
                                               TextWrapping="Wrap"
                                               FontFamily="Cascadia Mono, Consolas, monospace"
                                               FontSize="11"
                                               Foreground="{StaticResource Subtext0Brush}"/>
                                </Grid>

                                <DataTemplate.Triggers>
                                    <DataTrigger Binding="{Binding IsToolInput}" Value="True">
                                        <Setter TargetName="LogText"
                                                Property="Foreground"
                                                Value="{StaticResource TealBrush}"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding IsToolOutput}" Value="True">
                                        <Setter TargetName="LogText"
                                                Property="Foreground"
                                                Value="{StaticResource PeachBrush}"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding IsError}" Value="True">
                                        <Setter TargetName="LogText"
                                                Property="Foreground"
                                                Value="{StaticResource RedBrush}"/>
                                    </DataTrigger>
                                </DataTemplate.Triggers>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </Grid>
        </Grid>

        <!-- ═══════════════════════════════════════════════════════════
             MEMORY BROWSER
             User-initiated data management panel. DataContext is set
             to MemoryBrowserViewModel in code-behind.
             ═══════════════════════════════════════════════════════ -->
        <Grid Grid.Row="1" x:Name="MemoryView" Visibility="Collapsed">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>  <!-- Sub-tabs + search -->
                <RowDefinition Height="*"/>     <!-- DataGrid area -->
                <RowDefinition Height="Auto"/>  <!-- Footer: pagination + actions -->
            </Grid.RowDefinitions>

            <!-- ── Sub-tabs + Search Bar ─────────────────────────────── -->
            <Border Grid.Row="0"
                    Background="{StaticResource MantleBrush}"
                    Padding="12,8"
                    BorderBrush="{StaticResource Surface0Brush}"
                    BorderThickness="0,0,0,1">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <!-- Sub-tabs -->
                    <StackPanel Grid.Column="0"
                                Orientation="Horizontal"
                                VerticalAlignment="Center">
                        <RadioButton Content="Facts"
                                     IsChecked="True"
                                     GroupName="MemoryTabs"
                                     Click="MemorySubTab_Click"
                                     Tag="Facts"
                                     Style="{StaticResource MemorySubTabStyle}"/>
                        <RadioButton Content="Events"
                                     GroupName="MemoryTabs"
                                     Click="MemorySubTab_Click"
                                     Tag="Events"
                                     Style="{StaticResource MemorySubTabStyle}"
                                     Margin="4,0,0,0"/>
                        <RadioButton Content="Chunks"
                                     GroupName="MemoryTabs"
                                     Click="MemorySubTab_Click"
                                     Tag="Chunks"
                                     Style="{StaticResource MemorySubTabStyle}"
                                     Margin="4,0,0,0"/>
                    </StackPanel>

                    <!-- Search box -->
                    <TextBox Grid.Column="1"
                             x:Name="MemorySearchBox"
                             Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                             Style="{StaticResource ChatInputStyle}"
                             FontSize="12"
                             Padding="8,5"
                             Margin="16,0,0,0"
                             Tag="Search memories..."/>
                </Grid>
            </Border>

            <!-- ── DataGrid Area ─────────────────────────────────────── -->
            <Grid Grid.Row="1" Background="{StaticResource BaseBrush}">

                <!-- Facts Grid -->
                <DataGrid x:Name="FactsGrid"
                          ItemsSource="{Binding Facts}"
                          SelectedItem="{Binding SelectedItem, Mode=TwoWay}"
                          Style="{StaticResource MemoryDataGridStyle}"
                          CellStyle="{StaticResource MemoryDataGridCellStyle}"
                          ColumnHeaderStyle="{StaticResource MemoryColumnHeaderStyle}"
                          RowStyle="{StaticResource MemoryDataGridRowStyle}"
                          CellEditEnding="DataGrid_CellEditEnding">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Profile"    Binding="{Binding ProfileId}"  Width="90" IsReadOnly="True"/>
                        <DataGridTextColumn Header="Subject"    Binding="{Binding Subject}"   Width="*" />
                        <DataGridTextColumn Header="Predicate"  Binding="{Binding Predicate}" Width="*" />
                        <DataGridTextColumn Header="Object"     Binding="{Binding Object}"    Width="1.5*" />
                        <DataGridTextColumn Header="Confidence" Binding="{Binding Confidence, StringFormat=F2}" Width="80" IsReadOnly="True"/>
                        <DataGridTextColumn Header="Updated"    Binding="{Binding UpdatedAt, StringFormat=yyyy-MM-dd HH:mm}" Width="130" IsReadOnly="True"/>
                        <DataGridTextColumn Header="Source"     Binding="{Binding SourceRef}"  Width="100" IsReadOnly="True"/>
                    </DataGrid.Columns>
                </DataGrid>

                <!-- Events Grid -->
                <DataGrid x:Name="EventsGrid"
                          ItemsSource="{Binding Events}"
                          SelectedItem="{Binding SelectedItem, Mode=TwoWay}"
                          Visibility="Collapsed"
                          Style="{StaticResource MemoryDataGridStyle}"
                          CellStyle="{StaticResource MemoryDataGridCellStyle}"
                          ColumnHeaderStyle="{StaticResource MemoryColumnHeaderStyle}"
                          RowStyle="{StaticResource MemoryDataGridRowStyle}"
                          CellEditEnding="DataGrid_CellEditEnding">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Type"    Binding="{Binding Type}"    Width="100" />
                        <DataGridTextColumn Header="Title"   Binding="{Binding Title}"   Width="*" />
                        <DataGridTextColumn Header="Summary" Binding="{Binding Summary}" Width="1.5*" />
                        <DataGridTextColumn Header="When"    Binding="{Binding WhenIso, StringFormat=yyyy-MM-dd HH:mm}" Width="130" IsReadOnly="True"/>
                        <DataGridTextColumn Header="Source"  Binding="{Binding SourceRef}" Width="100" IsReadOnly="True"/>
                    </DataGrid.Columns>
                </DataGrid>

                <!-- Chunks Grid -->
                <DataGrid x:Name="ChunksGrid"
                          ItemsSource="{Binding Chunks}"
                          SelectedItem="{Binding SelectedItem, Mode=TwoWay}"
                          Visibility="Collapsed"
                          Style="{StaticResource MemoryDataGridStyle}"
                          CellStyle="{StaticResource MemoryDataGridCellStyle}"
                          ColumnHeaderStyle="{StaticResource MemoryColumnHeaderStyle}"
                          RowStyle="{StaticResource MemoryDataGridRowStyle}"
                          CellEditEnding="DataGrid_CellEditEnding">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Source Type" Binding="{Binding SourceType}" Width="100" />
                        <DataGridTextColumn Header="Text"        Binding="{Binding Text}"       Width="*" />
                        <DataGridTextColumn Header="When"        Binding="{Binding WhenIso, StringFormat=yyyy-MM-dd HH:mm}" Width="130" IsReadOnly="True"/>
                        <DataGridTextColumn Header="Source"      Binding="{Binding SourceRef}"   Width="100" IsReadOnly="True"/>
                    </DataGrid.Columns>
                </DataGrid>

                <!-- Empty state -->
                <TextBlock x:Name="MemoryEmptyState"
                           Text="No memories found."
                           FontSize="14"
                           Foreground="{StaticResource Overlay0Brush}"
                           HorizontalAlignment="Center"
                           VerticalAlignment="Center"
                           Visibility="Collapsed"/>
            </Grid>

            <!-- ── Footer: Pagination + Actions ──────────────────────── -->
            <Border Grid.Row="2"
                    Background="{StaticResource MantleBrush}"
                    Padding="12,8"
                    BorderBrush="{StaticResource Surface0Brush}"
                    BorderThickness="0,1,0,0">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <!-- Pagination -->
                    <StackPanel Grid.Column="0"
                                Orientation="Horizontal"
                                VerticalAlignment="Center">
                        <Button Content="&#x25C0; Prev"
                                Command="{Binding PrevPageCommand}"
                                Style="{StaticResource MemoryActionButtonStyle}"
                                Margin="0,0,6,0"/>
                        <TextBlock Text="{Binding PageDisplay}"
                                   FontSize="11"
                                   Foreground="{StaticResource Subtext0Brush}"
                                   VerticalAlignment="Center"
                                   Margin="0,0,6,0"/>
                        <Button Content="Next &#x25B6;"
                                Command="{Binding NextPageCommand}"
                                Style="{StaticResource MemoryActionButtonStyle}"/>
                    </StackPanel>

                    <!-- Status -->
                    <TextBlock Grid.Column="1"
                               Text="{Binding StatusText}"
                               FontSize="11"
                               Foreground="{StaticResource Overlay0Brush}"
                               HorizontalAlignment="Center"
                               VerticalAlignment="Center"/>

                    <!-- Actions -->
                    <StackPanel Grid.Column="2"
                                Orientation="Horizontal"
                                VerticalAlignment="Center">
                        <Button Content="+ Add New"
                                Command="{Binding AddNewCommand}"
                                Style="{StaticResource MemoryActionButtonStyle}"
                                Margin="0,0,6,0"/>
                        <Button Content="Refresh"
                                Command="{Binding RefreshCommand}"
                                Style="{StaticResource MemoryActionButtonStyle}"
                                Margin="0,0,6,0"/>
                        <Button Content="Delete Selected"
                                Command="{Binding DeleteCommand}"
                                Style="{StaticResource MemoryDeleteButtonStyle}"/>
                    </StackPanel>
                </Grid>
            </Border>
        </Grid>

        <!-- ═══════════════════════════════════════════════════════════
             PROFILE / NUGGETS BROWSER
             User-initiated identity + personal facts management.
             DataContext is set to ProfileBrowserViewModel in code-behind.
             ═══════════════════════════════════════════════════════ -->
        <Grid Grid.Row="1" x:Name="ProfileView" Visibility="Collapsed">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>  <!-- Sub-tabs + search -->
                <RowDefinition Height="*"/>     <!-- Grid area -->
                <RowDefinition Height="Auto"/>  <!-- Footer -->
            </Grid.RowDefinitions>

            <!-- ── Sub-tabs + Nugget Search ──────────────────────────────── -->
            <Border Grid.Row="0"
                    Background="{StaticResource MantleBrush}"
                    Padding="12,8"
                    BorderBrush="{StaticResource Surface0Brush}"
                    BorderThickness="0,0,0,1">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <StackPanel Grid.Column="0"
                                Orientation="Horizontal"
                                VerticalAlignment="Center">
                        <RadioButton Content="Profiles"
                                     IsChecked="True"
                                     GroupName="ProfileTabs"
                                     Click="ProfileSubTab_Click"
                                     Tag="Profiles"
                                     Style="{StaticResource MemorySubTabStyle}"/>
                        <RadioButton Content="Nuggets"
                                     GroupName="ProfileTabs"
                                     Click="ProfileSubTab_Click"
                                     Tag="Nuggets"
                                     Style="{StaticResource MemorySubTabStyle}"
                                     Margin="4,0,0,0"/>
                    </StackPanel>

                    <!-- Search box (nuggets only) -->
                    <TextBox Grid.Column="1"
                             x:Name="NuggetSearchBox"
                             Text="{Binding NuggetSearchText, UpdateSourceTrigger=PropertyChanged}"
                             Style="{StaticResource ChatInputStyle}"
                             FontSize="12"
                             Padding="8,5"
                             Margin="16,0,0,0"
                             Tag="Search nuggets..."/>
                </Grid>
            </Border>

            <!-- ── Grid Area ─────────────────────────────────────────────── -->
            <Grid Grid.Row="1" Background="{StaticResource BaseBrush}">

                <!-- Profile Cards DataGrid -->
                <DataGrid x:Name="ProfilesGrid"
                          ItemsSource="{Binding Profiles}"
                          SelectedItem="{Binding SelectedProfile, Mode=TwoWay}"
                          Style="{StaticResource MemoryDataGridStyle}"
                          CellStyle="{StaticResource MemoryDataGridCellStyle}"
                          ColumnHeaderStyle="{StaticResource MemoryColumnHeaderStyle}"
                          RowStyle="{StaticResource MemoryDataGridRowStyle}"
                          CellEditEnding="ProfileGrid_CellEditEnding">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Kind"         Binding="{Binding Kind}"         Width="80" IsReadOnly="True"/>
                        <DataGridTextColumn Header="Display Name" Binding="{Binding DisplayName}"  Width="*"/>
                        <DataGridTextColumn Header="Relationship" Binding="{Binding Relationship}" Width="120"/>
                        <DataGridTextColumn Header="Aliases"      Binding="{Binding Aliases}"      Width="*"/>
                        <DataGridTextColumn Header="Profile JSON" Binding="{Binding ProfileJson}"  Width="1.5*"/>
                        <DataGridTextColumn Header="Updated"      Binding="{Binding UpdatedAt, StringFormat=yyyy-MM-dd HH:mm}" Width="130" IsReadOnly="True"/>
                    </DataGrid.Columns>
                </DataGrid>

                <!-- Nuggets DataGrid -->
                <DataGrid x:Name="NuggetsGrid"
                          ItemsSource="{Binding Nuggets}"
                          SelectedItem="{Binding SelectedNugget, Mode=TwoWay}"
                          Visibility="Collapsed"
                          Style="{StaticResource MemoryDataGridStyle}"
                          CellStyle="{StaticResource MemoryDataGridCellStyle}"
                          ColumnHeaderStyle="{StaticResource MemoryColumnHeaderStyle}"
                          RowStyle="{StaticResource MemoryDataGridRowStyle}"
                          CellEditEnding="NuggetGrid_CellEditEnding">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Text"         Binding="{Binding Text}"        Width="*"/>
                        <DataGridTextColumn Header="Tags"         Binding="{Binding Tags}"        Width="140"/>
                        <DataGridTextColumn Header="Weight"       Binding="{Binding Weight, StringFormat=F2}" Width="70"/>
                        <DataGridTextColumn Header="Pin"          Binding="{Binding PinLevel}"    Width="50"/>
                        <DataGridTextColumn Header="Sensitivity"  Binding="{Binding Sensitivity}" Width="90"/>
                        <DataGridTextColumn Header="Uses"         Binding="{Binding UseCount}"    Width="50" IsReadOnly="True"/>
                        <DataGridTextColumn Header="Last Used"    Binding="{Binding LastUsedAt, StringFormat=yyyy-MM-dd}" Width="100" IsReadOnly="True"/>
                        <DataGridTextColumn Header="Created"      Binding="{Binding CreatedAt, StringFormat=yyyy-MM-dd}" Width="100" IsReadOnly="True"/>
                    </DataGrid.Columns>
                </DataGrid>
            </Grid>

            <!-- ── Footer: Actions ───────────────────────────────────────── -->
            <Border Grid.Row="2"
                    Background="{StaticResource MantleBrush}"
                    Padding="12,8"
                    BorderBrush="{StaticResource Surface0Brush}"
                    BorderThickness="0,1,0,0">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <!-- Pagination (nuggets only) -->
                    <StackPanel Grid.Column="0"
                                Orientation="Horizontal"
                                VerticalAlignment="Center"
                                x:Name="NuggetPaginationPanel"
                                Visibility="Collapsed">
                        <Button Content="◀ Prev"
                                Command="{Binding NuggetPrevPageCommand}"
                                Style="{StaticResource MemoryActionButtonStyle}"
                                Margin="0,0,6,0"/>
                        <TextBlock Text="{Binding NuggetPageDisplay}"
                                   FontSize="11"
                                   Foreground="{StaticResource Subtext0Brush}"
                                   VerticalAlignment="Center"
                                   Margin="0,0,6,0"/>
                        <Button Content="Next ▶"
                                Command="{Binding NuggetNextPageCommand}"
                                Style="{StaticResource MemoryActionButtonStyle}"/>
                    </StackPanel>

                    <!-- Status -->
                    <TextBlock Grid.Column="1"
                               Text="{Binding StatusText}"
                               FontSize="11"
                               Foreground="{StaticResource Overlay0Brush}"
                               HorizontalAlignment="Center"
                               VerticalAlignment="Center"/>

                    <!-- Actions -->
                    <StackPanel Grid.Column="2"
                                Orientation="Horizontal"
                                VerticalAlignment="Center">
                        <Button x:Name="ProfileAddButton"
                                Content="+ Add Profile"
                                Command="{Binding AddProfileCommand}"
                                Style="{StaticResource MemoryActionButtonStyle}"
                                Margin="0,0,6,0"/>
                        <Button x:Name="NuggetAddButton"
                                Content="+ Add Nugget"
                                Command="{Binding AddNuggetCommand}"
                                Style="{StaticResource MemoryActionButtonStyle}"
                                Visibility="Collapsed"
                                Margin="0,0,6,0"/>
                        <Button Content="Refresh"
                                Command="{Binding RefreshCommand}"
                                Style="{StaticResource MemoryActionButtonStyle}"
                                Margin="0,0,6,0"/>
                        <Button x:Name="ProfileDeleteButton"
                                Content="Delete Selected"
                                Command="{Binding DeleteProfileCommand}"
                                Style="{StaticResource MemoryDeleteButtonStyle}"/>
                        <Button x:Name="NuggetDeleteButton"
                                Content="Delete Selected"
                                Command="{Binding DeleteNuggetCommand}"
                                Style="{StaticResource MemoryDeleteButtonStyle}"
                                Visibility="Collapsed"/>
                    </StackPanel>
                </Grid>
            </Border>
        </Grid>

        <!-- ═══════════════════════════════════════════════════════════
             SETTINGS
             Common configuration surfaced in-app. Changes are
             persisted to settings.json on save.
             ═══════════════════════════════════════════════════════ -->
        <Grid Grid.Row="1" x:Name="SettingsView" Visibility="Collapsed">
            <ScrollViewer VerticalScrollBarVisibility="Auto"
                          HorizontalScrollBarVisibility="Disabled"
                          Background="{StaticResource BaseBrush}">
                <StackPanel Margin="32,24,32,24" MaxWidth="560">

                    <!-- ── Active Profile ──────────────────────────────── -->
                    <TextBlock Text="ACTIVE PROFILE"
                               FontSize="11" FontWeight="Bold"
                               Foreground="{StaticResource MauveBrush}"
                               Margin="0,0,0,8"/>
                    <TextBlock Text="Who is using the assistant right now? The selected profile is automatically injected so the assistant knows your name, preferences, and context."
                               FontSize="11.5"
                               Foreground="{StaticResource Overlay0Brush}"
                               TextWrapping="Wrap"
                               Margin="0,0,0,8"/>
                    <ComboBox x:Name="ProfileCombo"
                              ItemsSource="{Binding AvailableProfiles}"
                              SelectedItem="{Binding SelectedProfile, Mode=TwoWay}"
                              DisplayMemberPath="DisplayLabel"
                              Style="{StaticResource DarkComboBoxStyle}"
                              ItemContainerStyle="{StaticResource DarkComboBoxItemStyle}"
                              Margin="0,0,0,20"/>

                    <!-- ── Separator ───────────────────────────────────── -->
                    <Border Height="1"
                            Background="{StaticResource Surface0Brush}"
                            Margin="0,0,0,20"/>

                    <!-- ── LLM ─────────────────────────────────────────── -->
                    <TextBlock Text="LLM CONNECTION"
                               FontSize="11" FontWeight="Bold"
                               Foreground="{StaticResource BlueBrush}"
                               Margin="0,0,0,8"/>

                    <Grid Margin="0,0,0,8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="120"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="Base URL"
                                   FontSize="12"
                                   Foreground="{StaticResource Subtext0Brush}"
                                   VerticalAlignment="Center"/>
                        <TextBox Grid.Column="1"
                                 Text="{Binding LlmBaseUrl, UpdateSourceTrigger=LostFocus}"
                                 Style="{StaticResource ChatInputStyle}"
                                 FontSize="12" Padding="8,6"/>
                    </Grid>

                    <Grid Margin="0,0,0,8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="120"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="Model"
                                   FontSize="12"
                                   Foreground="{StaticResource Subtext0Brush}"
                                   VerticalAlignment="Center"/>
                        <TextBox Grid.Column="1"
                                 Text="{Binding LlmModel, UpdateSourceTrigger=LostFocus}"
                                 Style="{StaticResource ChatInputStyle}"
                                 FontSize="12" Padding="8,6"/>
                    </Grid>

                    <Grid Margin="0,0,0,8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="120"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="Max Tokens"
                                   FontSize="12"
                                   Foreground="{StaticResource Subtext0Brush}"
                                   VerticalAlignment="Center"/>
                        <TextBox Grid.Column="1"
                                 Text="{Binding LlmMaxTokens, UpdateSourceTrigger=LostFocus}"
                                 Style="{StaticResource ChatInputStyle}"
                                 FontSize="12" Padding="8,6"/>
                    </Grid>

                    <Grid Margin="0,0,0,8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="120"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="Temperature"
                                   FontSize="12"
                                   Foreground="{StaticResource Subtext0Brush}"
                                   VerticalAlignment="Center"/>
                        <TextBox Grid.Column="1"
                                 Text="{Binding LlmTemperature, UpdateSourceTrigger=LostFocus}"
                                 Style="{StaticResource ChatInputStyle}"
                                 FontSize="12" Padding="8,6"/>
                    </Grid>

                    <Grid Margin="0,0,0,20">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="160"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="First Principles Thinking"
                                   FontSize="12"
                                   Foreground="{StaticResource Subtext0Brush}"
                                   VerticalAlignment="Center"/>
                        <ComboBox Grid.Column="1"
                                  SelectedValue="{Binding ReasoningGuardrails, Mode=TwoWay}"
                                  SelectedValuePath="Content"
                                  Style="{StaticResource DarkComboBoxStyle}"
                                  ItemContainerStyle="{StaticResource DarkComboBoxItemStyle}">
                            <ComboBoxItem Content="off"/>
                            <ComboBoxItem Content="auto"/>
                            <ComboBoxItem Content="always"/>
                        </ComboBox>
                    </Grid>
                    <TextBlock Text="First Principles Thinking (Off/Auto/Always). Use Always to force goal/constraint/decision checks on each non-tool turn."
                               FontSize="10.5"
                               Foreground="{StaticResource Overlay0Brush}"
                               TextWrapping="Wrap"
                               Margin="0,0,0,20"/>

                    <!-- ── Separator ───────────────────────────────────── -->
                    <Border Height="1"
                            Background="{StaticResource Surface0Brush}"
                            Margin="0,0,0,20"/>

                    <!-- ── Memory ──────────────────────────────────────── -->
                    <TextBlock Text="MEMORY"
                               FontSize="11" FontWeight="Bold"
                               Foreground="{StaticResource GreenBrush}"
                               Margin="0,0,0,8"/>

                    <CheckBox Content="Enable memory (read + write)"
                              IsChecked="{Binding MemoryEnabled}"
                              Foreground="{StaticResource TextBrush}"
                              FontSize="12"
                              Margin="0,0,0,4"/>
                    <TextBlock Text="When off, all memory features are disabled — no retrieval, no storage, no prompts."
                               FontSize="10.5"
                               Foreground="{StaticResource Overlay0Brush}"
                               TextWrapping="Wrap"
                               Margin="18,0,0,6"/>
                    <CheckBox Content="Use embeddings for semantic search"
                              IsChecked="{Binding EmbeddingsEnabled}"
                              Foreground="{StaticResource TextBrush}"
                              FontSize="12"
                              Margin="0,0,0,20"/>

                    <!-- ── Separator ───────────────────────────────────── -->
                    <Border Height="1"
                            Background="{StaticResource Surface0Brush}"
                            Margin="0,0,0,20"/>

                    <!-- ── Weather ─────────────────────────────────────── -->
                    <TextBlock Text="WEATHER"
                               FontSize="11" FontWeight="Bold"
                               Foreground="{StaticResource BlueBrush}"
                               Margin="0,0,0,4"/>
                    <TextBlock Text="User-Agent is sent to weather providers. NWS requires a non-empty identifier."
                               FontSize="10.5"
                               Foreground="{StaticResource Overlay0Brush}"
                               TextWrapping="Wrap"
                               Margin="0,0,0,12"/>

                    <Grid Margin="0,0,0,20">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="140"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="User-Agent"
                                   FontSize="12"
                                   Foreground="{StaticResource Subtext0Brush}"
                                   VerticalAlignment="Center"/>
                        <TextBox Grid.Column="1"
                                 Text="{Binding WeatherUserAgent, UpdateSourceTrigger=LostFocus}"
                                 Style="{StaticResource ChatInputStyle}"
                                 FontSize="12" Padding="8,6"/>
                    </Grid>

                    <!-- ── MCP Permissions ─────────────────────────────── -->
                    <TextBlock Text="MCP PERMISSIONS"
                               FontSize="11" FontWeight="Bold"
                               Foreground="{StaticResource YellowBrush}"
                               Margin="0,0,0,4"/>
                    <TextBlock Text="Controls which tool groups the assistant may use. Off = hard block (no prompt). Ask = prompt every call. Always = auto-approve."
                               FontSize="10.5"
                               Foreground="{StaticResource Overlay0Brush}"
                               TextWrapping="Wrap"
                               Margin="0,0,0,12"/>

                    <!-- Developer Override -->
                    <Grid Margin="0,0,0,12">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="140"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="Developer override"
                                   FontSize="12"
                                   FontWeight="SemiBold"
                                   Foreground="{StaticResource PeachBrush}"
                                   VerticalAlignment="Center"/>
                        <ComboBox Grid.Column="1"
                                  SelectedValue="{Binding McpPermDeveloperOverride, Mode=TwoWay}"
                                  SelectedValuePath="Content"
                                  Style="{StaticResource DarkComboBoxStyle}"
                                  ItemContainerStyle="{StaticResource DarkComboBoxItemStyle}">
                            <ComboBoxItem Content="none"/>
                            <ComboBoxItem Content="off"/>
                            <ComboBoxItem Content="ask"/>
                            <ComboBoxItem Content="always"/>
                        </ComboBox>
                    </Grid>
                    <TextBlock Text="Overrides Screen/Files/System/Web at runtime when not 'none'. Per-group settings are preserved and apply when override is reverted."
                               FontSize="10.5"
                               Foreground="{StaticResource Overlay0Brush}"
                               TextWrapping="Wrap"
                               Margin="0,0,0,12"/>

                    <!-- Per-group dropdowns -->
                    <Grid Margin="0,0,0,8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="140"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="Screen"
                                   FontSize="12"
                                   Foreground="{StaticResource Subtext0Brush}"
                                   VerticalAlignment="Center"/>
                        <ComboBox Grid.Column="1"
                                  SelectedValue="{Binding McpPermScreen, Mode=TwoWay}"
                                  SelectedValuePath="Content"
                                  Style="{StaticResource DarkComboBoxStyle}"
                                  ItemContainerStyle="{StaticResource DarkComboBoxItemStyle}">
                            <ComboBoxItem Content="off"/>
                            <ComboBoxItem Content="ask"/>
                            <ComboBoxItem Content="always"/>
                        </ComboBox>
                    </Grid>

                    <Grid Margin="0,0,0,8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="140"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="Files"
                                   FontSize="12"
                                   Foreground="{StaticResource Subtext0Brush}"
                                   VerticalAlignment="Center"/>
                        <ComboBox Grid.Column="1"
                                  SelectedValue="{Binding McpPermFiles, Mode=TwoWay}"
                                  SelectedValuePath="Content"
                                  Style="{StaticResource DarkComboBoxStyle}"
                                  ItemContainerStyle="{StaticResource DarkComboBoxItemStyle}">
                            <ComboBoxItem Content="off"/>
                            <ComboBoxItem Content="ask"/>
                            <ComboBoxItem Content="always"/>
                        </ComboBox>
                    </Grid>

                    <Grid Margin="0,0,0,8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="140"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="System"
                                   FontSize="12"
                                   Foreground="{StaticResource Subtext0Brush}"
                                   VerticalAlignment="Center"/>
                        <ComboBox Grid.Column="1"
                                  SelectedValue="{Binding McpPermSystem, Mode=TwoWay}"
                                  SelectedValuePath="Content"
                                  Style="{StaticResource DarkComboBoxStyle}"
                                  ItemContainerStyle="{StaticResource DarkComboBoxItemStyle}">
                            <ComboBoxItem Content="off"/>
                            <ComboBoxItem Content="ask"/>
                            <ComboBoxItem Content="always"/>
                        </ComboBox>
                    </Grid>

                    <Grid Margin="0,0,0,8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="140"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="Web"
                                   FontSize="12"
                                   Foreground="{StaticResource Subtext0Brush}"
                                   VerticalAlignment="Center"/>
                        <ComboBox Grid.Column="1"
                                  SelectedValue="{Binding McpPermWeb, Mode=TwoWay}"
                                  SelectedValuePath="Content"
                                  Style="{StaticResource DarkComboBoxStyle}"
                                  ItemContainerStyle="{StaticResource DarkComboBoxItemStyle}">
                            <ComboBoxItem Content="off"/>
                            <ComboBoxItem Content="ask"/>
                            <ComboBoxItem Content="always"/>
                        </ComboBox>
                    </Grid>

                    <Grid Margin="0,0,0,8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="140"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="Memory Read"
                                   FontSize="12"
                                   Foreground="{StaticResource Subtext0Brush}"
                                   VerticalAlignment="Center"/>
                        <ComboBox Grid.Column="1"
                                  SelectedValue="{Binding McpPermMemoryRead, Mode=TwoWay}"
                                  SelectedValuePath="Content"
                                  Style="{StaticResource DarkComboBoxStyle}"
                                  ItemContainerStyle="{StaticResource DarkComboBoxItemStyle}">
                            <ComboBoxItem Content="off"/>
                            <ComboBoxItem Content="ask"/>
                            <ComboBoxItem Content="always"/>
                        </ComboBox>
                    </Grid>

                    <Grid Margin="0,0,0,20">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="140"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="Memory Write"
                                   FontSize="12"
                                   Foreground="{StaticResource Subtext0Brush}"
                                   VerticalAlignment="Center"/>
                        <ComboBox Grid.Column="1"
                                  SelectedValue="{Binding McpPermMemoryWrite, Mode=TwoWay}"
                                  SelectedValuePath="Content"
                                  Style="{StaticResource DarkComboBoxStyle}"
                                  ItemContainerStyle="{StaticResource DarkComboBoxItemStyle}">
                            <ComboBoxItem Content="off"/>
                            <ComboBoxItem Content="ask"/>
                            <ComboBoxItem Content="always"/>
                        </ComboBox>
                    </Grid>

                    <!-- ── Separator ───────────────────────────────────── -->
                    <Border Height="1"
                            Background="{StaticResource Surface0Brush}"
                            Margin="0,0,0,20"/>

                    <!-- ── Audio Devices ───────────────────────────────── -->
                    <TextBlock Text="AUDIO DEVICES"
                               FontSize="11" FontWeight="Bold"
                               Foreground="{StaticResource TealBrush}"
                               Margin="0,0,0,4"/>
                    <TextBlock Text="Select recording and playback devices. Use Test to verify levels before a voice session."
                               FontSize="10.5"
                               Foreground="{StaticResource Overlay0Brush}"
                               TextWrapping="Wrap"
                               Margin="0,0,0,12"/>

                    <!-- Input Device -->
                    <Grid Margin="0,0,0,8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="120"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="Input Device"
                                   FontSize="12"
                                   Foreground="{StaticResource Subtext0Brush}"
                                   VerticalAlignment="Center"/>
                        <ComboBox Grid.Column="1"
                                  ItemsSource="{Binding AvailableInputDevices}"
                                  SelectedItem="{Binding SelectedInputDevice, Mode=TwoWay}"
                                  DisplayMemberPath="DisplayName"
                                  Style="{StaticResource DarkComboBoxStyle}"
                                  ItemContainerStyle="{StaticResource DarkComboBoxItemStyle}"/>
                    </Grid>

                    <!-- Output Device -->
                    <Grid Margin="0,0,0,8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="120"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="Output Device"
                                   FontSize="12"
                                   Foreground="{StaticResource Subtext0Brush}"
                                   VerticalAlignment="Center"/>
                        <ComboBox Grid.Column="1"
                                  ItemsSource="{Binding AvailableOutputDevices}"
                                  SelectedItem="{Binding SelectedOutputDevice, Mode=TwoWay}"
                                  DisplayMemberPath="DisplayName"
                                  Style="{StaticResource DarkComboBoxStyle}"
                                  ItemContainerStyle="{StaticResource DarkComboBoxItemStyle}"/>
                    </Grid>

                    <!-- Input Gain -->
                    <Grid Margin="0,0,0,12">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="120"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="40"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="Input Gain"
                                   FontSize="12"
                                   Foreground="{StaticResource Subtext0Brush}"
                                   VerticalAlignment="Center"/>
                        <Slider Grid.Column="1"
                                Value="{Binding InputGain}"
                                Minimum="0" Maximum="2"
                                TickFrequency="0.1"
                                IsSnapToTickEnabled="True"
                                VerticalAlignment="Center"/>
                        <TextBlock Grid.Column="2"
                                   Text="{Binding InputGain, StringFormat={}{0:F1}x}"
                                   FontSize="11"
                                   Foreground="{StaticResource Overlay0Brush}"
                                   VerticalAlignment="Center"
                                   HorizontalAlignment="Right"/>
                    </Grid>

                    <!-- Microphone Test -->
                    <TextBlock Text="MICROPHONE TEST"
                               FontSize="11" FontWeight="Bold"
                               Foreground="{StaticResource TealBrush}"
                               Margin="0,8,0,8"/>

                    <!-- Level Meter -->
                    <Grid Margin="0,0,0,8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="120"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="Level"
                                   FontSize="12"
                                   Foreground="{StaticResource Subtext0Brush}"
                                   VerticalAlignment="Center"/>
                        <ProgressBar Grid.Column="1"
                                     Value="{Binding MicTestLevel, Mode=OneWay}"
                                     Minimum="0" Maximum="1"
                                     Height="10"
                                     Background="{StaticResource Surface0Brush}"
                                     Foreground="{StaticResource GreenBrush}"
                                     BorderThickness="0"/>
                    </Grid>

                    <!-- Test Status -->
                    <TextBlock Text="{Binding MicTestStatus}"
                               FontSize="10.5"
                               Foreground="{StaticResource Overlay0Brush}"
                               TextWrapping="Wrap"
                               Margin="0,0,0,8"/>

                    <!-- Test Buttons -->
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,20">
                        <Button Content="Test Mic"
                                Command="{Binding TestMicCommand}"
                                Style="{StaticResource MemoryActionButtonStyle}"
                                Margin="0,0,8,0"/>
                        <Button Content="Stop"
                                Command="{Binding StopTestMicCommand}"
                                Style="{StaticResource MemoryActionButtonStyle}"
                                Margin="0,0,8,0"/>
                        <Button Content="Play Recording"
                                Command="{Binding PlayTestRecordingCommand}"
                                Style="{StaticResource MemoryActionButtonStyle}"
                                Margin="0,0,8,0"/>
                        <Button Content="Refresh Devices"
                                Command="{Binding RefreshDevicesCommand}"
                                Style="{StaticResource MemoryActionButtonStyle}"/>
                    </StackPanel>

                    <!-- ── Separator ───────────────────────────────────── -->
                    <Border Height="1"
                            Background="{StaticResource Surface0Brush}"
                            Margin="0,0,0,20"/>

                    <!-- ── Voice Hotkeys ───────────────────────────────── -->
                    <TextBlock Text="VOICE HOTKEYS"
                               FontSize="11" FontWeight="Bold"
                               Foreground="{StaticResource PeachBrush}"
                               Margin="0,0,0,8"/>

                    <CheckBox Content="Enable text-to-speech"
                              IsChecked="{Binding TtsEnabled}"
                              Foreground="{StaticResource TextBrush}"
                              FontSize="12"
                              Margin="0,0,0,6"/>

                    <Grid Margin="0,0,0,8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="120"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="PTT Key"
                                   FontSize="12"
                                   Foreground="{StaticResource Subtext0Brush}"
                                   VerticalAlignment="Center"/>
                        <TextBox Grid.Column="1"
                                 Text="{Binding PttKey, UpdateSourceTrigger=LostFocus}"
                                 Style="{StaticResource ChatInputStyle}"
                                 FontSize="12" Padding="8,6"/>
                    </Grid>

                    <Grid Margin="0,0,0,8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="120"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="PTT Chord"
                                   FontSize="12"
                                   Foreground="{StaticResource Subtext0Brush}"
                                   VerticalAlignment="Center"/>
                        <TextBox Grid.Column="1"
                                 Text="{Binding PttChord, UpdateSourceTrigger=LostFocus}"
                                 Style="{StaticResource ChatInputStyle}"
                                 FontSize="12" Padding="8,6"/>
                    </Grid>

                    <Grid Margin="0,0,0,8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="120"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="Shutup Chord"
                                   FontSize="12"
                                   Foreground="{StaticResource Subtext0Brush}"
                                   VerticalAlignment="Center"/>
                        <TextBox Grid.Column="1"
                                 Text="{Binding ShutupChord, UpdateSourceTrigger=LostFocus}"
                                 Style="{StaticResource ChatInputStyle}"
                                 FontSize="12" Padding="8,6"/>
                    </Grid>

                    <CheckBox Content="Enable VoiceHost"
                              IsChecked="{Binding VoiceHostEnabled}"
                              Foreground="{StaticResource TextBrush}"
                              FontSize="12"
                              Margin="0,0,0,8"/>

                    <Grid Margin="0,0,0,8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="120"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="VoiceHost URL"
                                   FontSize="12"
                                   Foreground="{StaticResource Subtext0Brush}"
                                   VerticalAlignment="Center"/>
                        <TextBox Grid.Column="1"
                                 Text="{Binding VoiceHostBaseUrl, UpdateSourceTrigger=LostFocus}"
                                 Style="{StaticResource ChatInputStyle}"
                                 FontSize="12" Padding="8,6"/>
                    </Grid>

                    <Grid Margin="0,0,0,8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="120"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="TTS Engine"
                                   FontSize="12"
                                   Foreground="{StaticResource Subtext0Brush}"
                                   VerticalAlignment="Center"/>
                        <TextBox Grid.Column="1"
                                 Text="{Binding VoiceTtsEngine, UpdateSourceTrigger=LostFocus}"
                                 Style="{StaticResource ChatInputStyle}"
                                 FontSize="12" Padding="8,6"/>
                    </Grid>

                    <Grid Margin="0,0,0,8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="120"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="TTS Model Id"
                                   FontSize="12"
                                   Foreground="{StaticResource Subtext0Brush}"
                                   VerticalAlignment="Center"/>
                        <TextBox Grid.Column="1"
                                 Text="{Binding VoiceTtsModelId, UpdateSourceTrigger=LostFocus}"
                                 Style="{StaticResource ChatInputStyle}"
                                 FontSize="12" Padding="8,6"/>
                    </Grid>

                    <Grid Margin="0,0,0,8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="120"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="TTS Voice Id"
                                   FontSize="12"
                                   Foreground="{StaticResource Subtext0Brush}"
                                   VerticalAlignment="Center"/>
                        <TextBox Grid.Column="1"
                                 Text="{Binding VoiceTtsVoiceId, UpdateSourceTrigger=LostFocus}"
                                 Style="{StaticResource ChatInputStyle}"
                                 FontSize="12" Padding="8,6"/>
                    </Grid>

                    <Grid Margin="0,0,0,8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="120"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="STT Engine"
                                   FontSize="12"
                                   Foreground="{StaticResource Subtext0Brush}"
                                   VerticalAlignment="Center"/>
                        <TextBox Grid.Column="1"
                                 Text="{Binding VoiceSttEngine, UpdateSourceTrigger=LostFocus}"
                                 Style="{StaticResource ChatInputStyle}"
                                 FontSize="12" Padding="8,6"/>
                    </Grid>

                    <Grid Margin="0,0,0,8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="120"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="STT Model Id"
                                   FontSize="12"
                                   Foreground="{StaticResource Subtext0Brush}"
                                   VerticalAlignment="Center"/>
                        <TextBox Grid.Column="1"
                                 Text="{Binding VoiceSttModelId, UpdateSourceTrigger=LostFocus}"
                                 Style="{StaticResource ChatInputStyle}"
                                 FontSize="12" Padding="8,6"/>
                    </Grid>

                    <CheckBox Content="Prefer local TTS endpoint"
                              IsChecked="{Binding VoicePreferLocalTts}"
                              Foreground="{StaticResource TextBrush}"
                              FontSize="12"
                              Margin="0,0,0,8"/>

                    <Grid Margin="0,0,0,8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="120"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="Health Path"
                                   FontSize="12"
                                   Foreground="{StaticResource Subtext0Brush}"
                                   VerticalAlignment="Center"/>
                        <TextBox Grid.Column="1"
                                 Text="{Binding VoiceHostHealthPath, UpdateSourceTrigger=LostFocus}"
                                 Style="{StaticResource ChatInputStyle}"
                                 FontSize="12" Padding="8,6"/>
                    </Grid>

                    <Grid Margin="0,0,0,8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="120"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="Host Startup ms"
                                   FontSize="12"
                                   Foreground="{StaticResource Subtext0Brush}"
                                   VerticalAlignment="Center"/>
                        <TextBox Grid.Column="1"
                                 Text="{Binding VoiceHostStartupTimeoutMs, UpdateSourceTrigger=LostFocus}"
                                 Style="{StaticResource ChatInputStyle}"
                                 FontSize="12" Padding="8,6"/>
                    </Grid>

                    <Grid Margin="0,0,0,8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="120"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="ASR Timeout ms"
                                   FontSize="12"
                                   Foreground="{StaticResource Subtext0Brush}"
                                   VerticalAlignment="Center"/>
                        <TextBox Grid.Column="1"
                                 Text="{Binding VoiceAsrTimeoutMs, UpdateSourceTrigger=LostFocus}"
                                 Style="{StaticResource ChatInputStyle}"
                                 FontSize="12" Padding="8,6"/>
                    </Grid>

                    <Grid Margin="0,0,0,8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="120"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="Agent Timeout"
                                   FontSize="12"
                                   Foreground="{StaticResource Subtext0Brush}"
                                   VerticalAlignment="Center"/>
                        <TextBox Grid.Column="1"
                                 Text="{Binding VoiceAgentTimeoutMs, UpdateSourceTrigger=LostFocus}"
                                 Style="{StaticResource ChatInputStyle}"
                                 FontSize="12" Padding="8,6"/>
                    </Grid>

                    <Grid Margin="0,0,0,20">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="120"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="Speak Timeout"
                                   FontSize="12"
                                   Foreground="{StaticResource Subtext0Brush}"
                                   VerticalAlignment="Center"/>
                        <TextBox Grid.Column="1"
                                 Text="{Binding VoiceSpeakingTimeoutMs, UpdateSourceTrigger=LostFocus}"
                                 Style="{StaticResource ChatInputStyle}"
                                 FontSize="12" Padding="8,6"/>
                    </Grid>

                    <!-- ─── VoiceHost Server ──────────────────────── -->
                    <Border Background="{StaticResource Surface0Brush}"
                            BorderBrush="{StaticResource Surface1Brush}"
                            BorderThickness="1"
                            CornerRadius="8"
                            Padding="12"
                            Margin="0,0,0,20">
                        <StackPanel>
                            <TextBlock Text="VoiceHost Server"
                                       FontSize="13"
                                       FontWeight="SemiBold"
                                       Foreground="{StaticResource TextBrush}"
                                       Margin="0,0,0,10"/>

                            <!-- Status row: indicator dot + status text -->
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                                <Ellipse Width="10" Height="10"
                                         VerticalAlignment="Center"
                                         Margin="0,0,8,0">
                                    <Ellipse.Style>
                                        <Style TargetType="Ellipse">
                                            <Setter Property="Fill" Value="{StaticResource RedBrush}"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding VoiceHostIsReady}" Value="True">
                                                    <Setter Property="Fill" Value="{StaticResource GreenBrush}"/>
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding VoiceHostIsReachable}" Value="True">
                                                    <Setter Property="Fill" Value="{StaticResource YellowBrush}"/>
                                                </DataTrigger>
                                                <!-- Ready overrides reachable — must come after -->
                                                <MultiDataTrigger>
                                                    <MultiDataTrigger.Conditions>
                                                        <Condition Binding="{Binding VoiceHostIsReady}" Value="True"/>
                                                        <Condition Binding="{Binding VoiceHostIsReachable}" Value="True"/>
                                                    </MultiDataTrigger.Conditions>
                                                    <Setter Property="Fill" Value="{StaticResource GreenBrush}"/>
                                                </MultiDataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Ellipse.Style>
                                </Ellipse>
                                <TextBlock FontSize="12"
                                           FontWeight="SemiBold"
                                           VerticalAlignment="Center">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="Text" Value="{Binding VoiceHostStatusText}"/>
                                            <Setter Property="Foreground" Value="{StaticResource Subtext0Brush}"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding VoiceHostIsReady}" Value="True">
                                                    <Setter Property="Foreground" Value="{StaticResource GreenBrush}"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                            </StackPanel>

                            <!-- Subsystem readiness indicators -->
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,6">
                                <StackPanel Orientation="Horizontal" Margin="0,0,16,0">
                                    <Ellipse Width="7" Height="7"
                                             VerticalAlignment="Center"
                                             Margin="0,0,5,0">
                                        <Ellipse.Style>
                                            <Style TargetType="Ellipse">
                                                <Setter Property="Fill" Value="{StaticResource Overlay0Brush}"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding VoiceHostAsrReady}" Value="True">
                                                        <Setter Property="Fill" Value="{StaticResource GreenBrush}"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Ellipse.Style>
                                    </Ellipse>
                                    <TextBlock Text="ASR"
                                               FontSize="11"
                                               Foreground="{StaticResource Overlay0Brush}"
                                               VerticalAlignment="Center"/>
                                </StackPanel>
                                <StackPanel Orientation="Horizontal" Margin="0,0,16,0">
                                    <Ellipse Width="7" Height="7"
                                             VerticalAlignment="Center"
                                             Margin="0,0,5,0">
                                        <Ellipse.Style>
                                            <Style TargetType="Ellipse">
                                                <Setter Property="Fill" Value="{StaticResource Overlay0Brush}"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding VoiceHostTtsReady}" Value="True">
                                                        <Setter Property="Fill" Value="{StaticResource GreenBrush}"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Ellipse.Style>
                                    </Ellipse>
                                    <TextBlock Text="TTS"
                                               FontSize="11"
                                               Foreground="{StaticResource Overlay0Brush}"
                                               VerticalAlignment="Center"/>
                                </StackPanel>
                                <TextBlock Text="{Binding VoiceHostVersion}"
                                           FontSize="10"
                                           Foreground="{StaticResource Overlay0Brush}"
                                           VerticalAlignment="Center"/>
                            </StackPanel>

                            <!-- Status message -->
                            <TextBlock Text="{Binding VoiceHostMessage}"
                                       FontSize="11"
                                       Foreground="{StaticResource Overlay0Brush}"
                                       TextWrapping="Wrap"
                                       Margin="0,0,0,10"/>

                            <!-- Action buttons -->
                            <StackPanel Orientation="Horizontal">
                                <Button Content="Start"
                                        Command="{Binding StartVoiceHostCommand}"
                                        Style="{StaticResource MemoryActionButtonStyle}"
                                        Margin="0,0,8,0"/>
                                <Button Content="Stop"
                                        Command="{Binding StopVoiceHostCommand}"
                                        Style="{StaticResource MemoryActionButtonStyle}"
                                        Margin="0,0,8,0"/>
                                <Button Content="Refresh"
                                        Command="{Binding RefreshVoiceHostCommand}"
                                        Style="{StaticResource MemoryActionButtonStyle}"/>
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <!-- ─── YouTube Transcribe ───────────────────────── -->
                    <Border Background="{StaticResource Surface0Brush}"
                            BorderBrush="{StaticResource Surface1Brush}"
                            BorderThickness="1"
                            CornerRadius="8"
                            Padding="12"
                            Margin="0,0,0,20">
                        <StackPanel>
                            <TextBlock Text="YouTube Transcribe"
                                       FontSize="13"
                                       FontWeight="SemiBold"
                                       Foreground="{StaticResource TextBrush}"
                                       Margin="0,0,0,8"/>

                            <Grid Margin="0,0,0,8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="120"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="Video URL"
                                           FontSize="12"
                                           Foreground="{StaticResource Subtext0Brush}"
                                           VerticalAlignment="Center"/>
                                <TextBox Grid.Column="1"
                                         Text="{Binding YouTubeUrl, UpdateSourceTrigger=LostFocus}"
                                         Style="{StaticResource ChatInputStyle}"
                                         FontSize="12" Padding="8,6"/>
                            </Grid>

                            <Grid Margin="0,0,0,8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="120"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="ASR Provider"
                                           FontSize="12"
                                           Foreground="{StaticResource Subtext0Brush}"
                                           VerticalAlignment="Center"/>
                                <TextBox Grid.Column="1"
                                         Text="{Binding YouTubeAsrProvider, UpdateSourceTrigger=LostFocus}"
                                         Style="{StaticResource ChatInputStyle}"
                                         FontSize="12" Padding="8,6"/>
                            </Grid>

                            <Grid Margin="0,0,0,8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="120"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="ASR Model"
                                           FontSize="12"
                                           Foreground="{StaticResource Subtext0Brush}"
                                           VerticalAlignment="Center"/>
                                <TextBox Grid.Column="1"
                                         Text="{Binding YouTubeAsrModelId, UpdateSourceTrigger=LostFocus}"
                                         Style="{StaticResource ChatInputStyle}"
                                         FontSize="12" Padding="8,6"/>
                            </Grid>

                            <Grid Margin="0,0,0,8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="120"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="Language Hint"
                                           FontSize="12"
                                           Foreground="{StaticResource Subtext0Brush}"
                                           VerticalAlignment="Center"/>
                                <TextBox Grid.Column="1"
                                         Text="{Binding YouTubeLanguageHint, UpdateSourceTrigger=LostFocus}"
                                         Style="{StaticResource ChatInputStyle}"
                                         FontSize="12" Padding="8,6"/>
                            </Grid>

                            <CheckBox Content="Keep converted audio files (do not clean work folder)"
                                      IsChecked="{Binding YouTubeKeepAudio}"
                                      Foreground="{StaticResource TextBrush}"
                                      FontSize="12"
                                      Margin="0,0,0,8"/>

                            <StackPanel Orientation="Horizontal"
                                        Margin="0,0,0,8">
                                <Button Content="Start YouTube Job"
                                        Command="{Binding StartYouTubeJobCommand}"
                                        Style="{StaticResource MemoryActionButtonStyle}"
                                        Margin="0,0,8,0"/>
                                <Button Content="Cancel"
                                        Command="{Binding CancelYouTubeJobCommand}"
                                        Style="{StaticResource MemoryActionButtonStyle}"/>
                            </StackPanel>

                            <TextBlock Text="{Binding YouTubeJobStatus}"
                                       FontSize="12"
                                       FontWeight="SemiBold"
                                       Foreground="{StaticResource Subtext0Brush}"/>
                            <TextBlock Text="{Binding YouTubeJobStage}"
                                       FontSize="11"
                                       Foreground="{StaticResource Overlay0Brush}"
                                       Margin="0,2,0,6"/>

                            <ProgressBar Height="8"
                                         IsIndeterminate="{Binding YouTubeJobIsRunning, Mode=OneWay}"
                                         Value="{Binding YouTubeJobProgressPercent, Mode=OneWay}"
                                         Maximum="100"
                                         Margin="0,0,0,6"/>
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                                <TextBlock Text="Progress: "
                                           FontSize="11"
                                           Foreground="{StaticResource Overlay0Brush}"/>
                                <TextBlock Text="{Binding YouTubeJobProgressPercent}"
                                           FontSize="11"
                                           Foreground="{StaticResource Overlay0Brush}"/>
                                <TextBlock Text="%"
                                           FontSize="11"
                                           Foreground="{StaticResource Overlay0Brush}"/>
                            </StackPanel>

                            <TextBlock Text="{Binding YouTubeErrorMessage}"
                                       Foreground="{StaticResource RedBrush}"
                                       FontSize="11"
                                       TextWrapping="Wrap"
                                       Margin="0,0,0,8"/>

                            <Grid Margin="0,0,0,8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="120"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="Transcript"
                                           FontSize="12"
                                           Foreground="{StaticResource Subtext0Brush}"
                                           VerticalAlignment="Center"/>
                                <TextBlock Grid.Column="1"
                                           Text="{Binding YouTubeTranscriptPath}"
                                           FontSize="11"
                                           Foreground="{StaticResource TextBrush}"
                                           TextWrapping="Wrap"/>
                            </Grid>

                            <Grid Margin="0,0,0,8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="120"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="Output Folder"
                                           FontSize="12"
                                           Foreground="{StaticResource Subtext0Brush}"
                                           VerticalAlignment="Center"/>
                                <TextBlock Grid.Column="1"
                                           Text="{Binding YouTubeOutputDir}"
                                           FontSize="11"
                                           Foreground="{StaticResource TextBrush}"
                                           TextWrapping="Wrap"/>
                            </Grid>

                            <TextBlock Text="Summary"
                                       FontSize="12"
                                       FontWeight="SemiBold"
                                       Foreground="{StaticResource Subtext0Brush}"
                                       Margin="0,4,0,4"/>
                            <TextBox Text="{Binding YouTubeSummary, Mode=OneWay}"
                                     IsReadOnly="True"
                                     MinHeight="140"
                                     MaxHeight="260"
                                     VerticalScrollBarVisibility="Auto"
                                     TextWrapping="Wrap"
                                     Style="{StaticResource ChatInputStyle}"
                                     FontSize="12"
                                     Padding="8,6"/>
                        </StackPanel>
                    </Border>

                    <!-- ── Separator ───────────────────────────────────── -->
                    <Border Height="1"
                            Background="{StaticResource Surface0Brush}"
                            Margin="0,0,0,20"/>

                    <!-- ── Actions ─────────────────────────────────────── -->
                    <StackPanel Orientation="Horizontal"
                                HorizontalAlignment="Right">
                        <TextBlock Text="{Binding StatusText}"
                                   FontSize="11"
                                   Foreground="{StaticResource Overlay0Brush}"
                                   VerticalAlignment="Center"
                                   Margin="0,0,12,0"/>
                        <Button Content="Refresh"
                                Command="{Binding RefreshCommand}"
                                Style="{StaticResource MemoryActionButtonStyle}"
                                Margin="0,0,8,0"/>
                        <Button Content="Save Settings"
                                Command="{Binding SaveCommand}"
                                Style="{StaticResource SendButtonStyle}"
                                Padding="14,8"/>
                    </StackPanel>
                </StackPanel>
            </ScrollViewer>
        </Grid>

        <!-- ═══════════════════════════════════════════════════════════
             INPUT AREA
             ═══════════════════════════════════════════════════════ -->
        <Border Grid.Row="2" x:Name="InputArea"
                Background="{StaticResource MantleBrush}"
                Padding="12"
                BorderBrush="{StaticResource Surface0Brush}"
                BorderThickness="0,1,0,0">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Context chips -->
                <ItemsControl Grid.Row="0"
                              Grid.ColumnSpan="2"
                              ItemsSource="{Binding ContextChips}"
                              Margin="0,0,0,8">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <WrapPanel Orientation="Horizontal"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border Margin="0,0,8,6"
                                    Padding="8,4"
                                    CornerRadius="10"
                                    BorderThickness="1">
                                <Border.Style>
                                    <Style TargetType="Border">
                                        <Setter Property="Background" Value="{StaticResource Surface0Brush}"/>
                                        <Setter Property="BorderBrush" Value="{StaticResource Surface1Brush}"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsWarning}" Value="True">
                                                <Setter Property="Background" Value="#44F38BA8"/>
                                                <Setter Property="BorderBrush" Value="#88F38BA8"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Border.Style>
                                <TextBlock Text="{Binding Text}"
                                           FontSize="11"
                                           Foreground="{StaticResource TextBrush}"/>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>

                <TextBox Grid.Row="1"
                         Grid.Column="0"
                         x:Name="ChatInput"
                         Style="{StaticResource ChatInputStyle}"
                         Text="{Binding InputText, UpdateSourceTrigger=PropertyChanged}"
                         Margin="0,0,8,0"/>

                <!-- Send / Cancel button swap -->
                <Grid Grid.Row="1" Grid.Column="1">
                    <!-- Send (visible when NOT processing) -->
                    <Button Content="Send ↵"
                            Command="{Binding SendCommand}">
                        <Button.Style>
                            <Style TargetType="Button"
                                   BasedOn="{StaticResource SendButtonStyle}">
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsProcessing}"
                                                 Value="True">
                                        <Setter Property="Visibility"
                                                Value="Collapsed"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                    </Button>

                    <!-- Cancel (visible when processing) -->
                    <Button Content="Cancel"
                            Command="{Binding CancelCommand}"
                            Visibility="{Binding IsProcessing,
                                         Converter={StaticResource BoolToVis}}"
                            Style="{StaticResource CancelButtonStyle}"/>
                </Grid>

                <!-- Voice debug panel (manual hold-to-talk + live transcript) -->
                <Border Grid.Row="2"
                        Grid.ColumnSpan="2"
                        Margin="0,8,0,0"
                        Padding="8,6"
                        Background="{StaticResource Surface0Brush}"
                        BorderBrush="{StaticResource Surface1Brush}"
                        BorderThickness="1"
                        CornerRadius="6">
                    <StackPanel>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <Button x:Name="PttButton"
                                    Content="Hold to Talk"
                                    Padding="12,5"
                                    FontSize="11"
                                    Foreground="{StaticResource TextBrush}"
                                    Background="{StaticResource Surface1Brush}"
                                    BorderBrush="{StaticResource BlueBrush}"
                                    BorderThickness="1"
                                    Cursor="Hand"
                                    PreviewMouseLeftButtonDown="PttButton_MouseDown"
                                    PreviewMouseLeftButtonUp="PttButton_MouseUp"
                                    MouseLeave="PttButton_MouseLeave"/>

                            <TextBlock Grid.Column="1"
                                       Text="{Binding VoiceStatusText}"
                                       FontSize="11"
                                       Foreground="{StaticResource Subtext0Brush}"
                                       VerticalAlignment="Center"
                                       Margin="10,0,0,0"/>

                            <Button Grid.Column="2"
                                    Content="Stop"
                                    Padding="10,4"
                                    FontSize="10"
                                    Click="VoiceStopButton_Click"
                                    Visibility="{Binding IsVoiceActive,
                                                 Converter={StaticResource BoolToVis}}"
                                    Style="{StaticResource CancelButtonStyle}"/>
                        </Grid>

                        <TextBox Text="{Binding VoiceTranscriptText, Mode=OneWay}"
                                 IsReadOnly="True"
                                 TextWrapping="Wrap"
                                 AcceptsReturn="True"
                                 MaxHeight="100"
                                 FontSize="11"
                                 FontFamily="Consolas"
                                 Foreground="{StaticResource TextBrush}"
                                 Background="{StaticResource MantleBrush}"
                                 BorderBrush="{StaticResource Surface1Brush}"
                                 BorderThickness="1"
                                 Padding="6,4"
                                 Margin="0,6,0,0"
                                 VerticalScrollBarVisibility="Auto"
                                 Visibility="{Binding IsVoiceActive,
                                              Converter={StaticResource BoolToVis}}"/>
                    </StackPanel>
                </Border>
            </Grid>
        </Border>
    </Grid>
</Window>
