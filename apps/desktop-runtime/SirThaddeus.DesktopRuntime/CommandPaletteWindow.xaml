<Window x:Class="SirThaddeus.DesktopRuntime.CommandPaletteWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:conv="clr-namespace:SirThaddeus.DesktopRuntime.Converters"
        Title="Chat"
        Width="960"
        Height="640"
        MinWidth="640"
        MinHeight="400"
        WindowStartupLocation="CenterScreen"
        WindowStyle="SingleBorderWindow"
        ResizeMode="CanResize"
        Background="#1E1E2E"
        Foreground="#CDD6F4"
        KeyDown="Window_KeyDown">

    <Window.Resources>
        <!-- ── Catppuccin Mocha Palette ────────────────────────────── -->
        <SolidColorBrush x:Key="BaseBrush"     Color="#1E1E2E"/>
        <SolidColorBrush x:Key="MantleBrush"   Color="#181825"/>
        <SolidColorBrush x:Key="CrustBrush"    Color="#11111B"/>
        <SolidColorBrush x:Key="Surface0Brush" Color="#313244"/>
        <SolidColorBrush x:Key="Surface1Brush" Color="#45475A"/>
        <SolidColorBrush x:Key="Surface2Brush" Color="#585B70"/>
        <SolidColorBrush x:Key="Overlay0Brush" Color="#6C7086"/>
        <SolidColorBrush x:Key="Subtext0Brush" Color="#A6ADC8"/>
        <SolidColorBrush x:Key="TextBrush"     Color="#CDD6F4"/>
        <SolidColorBrush x:Key="BlueBrush"     Color="#89B4FA"/>
        <SolidColorBrush x:Key="GreenBrush"    Color="#A6E3A1"/>
        <SolidColorBrush x:Key="RedBrush"      Color="#F38BA8"/>
        <SolidColorBrush x:Key="YellowBrush"   Color="#F9E2AF"/>
        <SolidColorBrush x:Key="MauveBrush"    Color="#CBA6F7"/>
        <SolidColorBrush x:Key="PeachBrush"    Color="#FAB387"/>
        <SolidColorBrush x:Key="TealBrush"     Color="#94E2D5"/>

        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
        <conv:Base64ToImageConverter  x:Key="Base64ToImage"/>
        <conv:StringToBrushConverter  x:Key="StringToBrush"/>
        <conv:UrlToImageConverter     x:Key="UrlToImage"/>
        <conv:MarkdownToFlowDocumentConverter x:Key="MarkdownToFlowDocument"/>

        <!-- ── Chat Input TextBox ──────────────────────────────────── -->
        <Style x:Key="ChatInputStyle" TargetType="TextBox">
            <Setter Property="Background"              Value="{StaticResource Surface0Brush}"/>
            <Setter Property="Foreground"              Value="{StaticResource TextBrush}"/>
            <Setter Property="CaretBrush"              Value="{StaticResource BlueBrush}"/>
            <Setter Property="BorderBrush"             Value="{StaticResource Surface1Brush}"/>
            <Setter Property="BorderThickness"         Value="1"/>
            <Setter Property="Padding"                 Value="12,10"/>
            <Setter Property="FontSize"                Value="14"/>
            <Setter Property="FontFamily"              Value="Segoe UI, sans-serif"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Setter Property="SelectionBrush"          Value="{StaticResource BlueBrush}"/>
            <Style.Triggers>
                <Trigger Property="IsFocused" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource BlueBrush}"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <!-- ── Send Button ─────────────────────────────────────────── -->
        <Style x:Key="SendButtonStyle" TargetType="Button">
            <Setter Property="Background"     Value="{StaticResource BlueBrush}"/>
            <Setter Property="Foreground"     Value="{StaticResource CrustBrush}"/>
            <Setter Property="FontWeight"     Value="SemiBold"/>
            <Setter Property="FontSize"       Value="13"/>
            <Setter Property="Padding"        Value="16,10"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor"         Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="Bd"
                                Background="{TemplateBinding Background}"
                                CornerRadius="8"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center"
                                              VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="#74C7EC"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="Bd" Property="Background"
                                        Value="{StaticResource Surface1Brush}"/>
                                <Setter Property="Foreground"
                                        Value="{StaticResource Overlay0Brush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- ── Cancel Button ───────────────────────────────────────── -->
        <Style x:Key="CancelButtonStyle" TargetType="Button">
            <Setter Property="Background"     Value="{StaticResource RedBrush}"/>
            <Setter Property="Foreground"     Value="{StaticResource CrustBrush}"/>
            <Setter Property="FontWeight"     Value="SemiBold"/>
            <Setter Property="FontSize"       Value="13"/>
            <Setter Property="Padding"        Value="16,10"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor"         Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="Bd"
                                Background="{TemplateBinding Background}"
                                CornerRadius="8"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center"
                                              VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="#EBA0AC"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- ── Header Button (New Chat) ────────────────────────────── -->
        <Style x:Key="HeaderButtonStyle" TargetType="Button">
            <Setter Property="Background"     Value="Transparent"/>
            <Setter Property="Foreground"     Value="{StaticResource Subtext0Brush}"/>
            <Setter Property="FontSize"       Value="12"/>
            <Setter Property="Padding"        Value="10,5"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor"         Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="Bd"
                                Background="{TemplateBinding Background}"
                                CornerRadius="4"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center"
                                              VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bd" Property="Background"
                                        Value="{StaticResource Surface0Brush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>  <!-- Header -->
            <RowDefinition Height="*"/>     <!-- Content (split) -->
            <RowDefinition Height="Auto"/>  <!-- Input -->
        </Grid.RowDefinitions>

        <!-- ═══════════════════════════════════════════════════════════
             HEADER
             ═══════════════════════════════════════════════════════ -->
        <Border Grid.Row="0"
                Background="{StaticResource MantleBrush}"
                Padding="16,10"
                BorderBrush="{StaticResource Surface0Brush}"
                BorderThickness="0,0,0,1">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Connection indicator -->
                <StackPanel Grid.Column="0"
                            Orientation="Horizontal"
                            VerticalAlignment="Center">
                    <Ellipse Width="8" Height="8"
                             Margin="0,0,8,0"
                             VerticalAlignment="Center">
                        <Ellipse.Style>
                            <Style TargetType="Ellipse">
                                <Setter Property="Fill" Value="{StaticResource RedBrush}"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsLlmConnected}" Value="True">
                                        <Setter Property="Fill" Value="{StaticResource GreenBrush}"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Ellipse.Style>
                    </Ellipse>
                    <TextBlock Text="{Binding ConnectionStatus}"
                               FontSize="12"
                               Foreground="{StaticResource Subtext0Brush}"
                               VerticalAlignment="Center"/>
                </StackPanel>

                <!-- New Chat -->
                <Button Grid.Column="1"
                        Content="New Chat"
                        Command="{Binding ClearCommand}"
                        Style="{StaticResource HeaderButtonStyle}"/>
            </Grid>
        </Border>

        <!-- ═══════════════════════════════════════════════════════════
             CONTENT — SPLIT PANE (Chat | Activity Log)
             ═══════════════════════════════════════════════════════ -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="3*"  MinWidth="260"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="2*"  MinWidth="200"/>
            </Grid.ColumnDefinitions>

            <!-- ── Left: Chat Messages ─────────────────────────────── -->
            <ScrollViewer Grid.Column="0"
                          x:Name="ChatScroller"
                          Background="{StaticResource BaseBrush}"
                          VerticalScrollBarVisibility="Auto"
                          HorizontalScrollBarVisibility="Disabled">
                <ItemsControl ItemsSource="{Binding Messages}"
                              Padding="12,8">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Grid Margin="0,3">
                                <Border x:Name="Bubble"
                                        CornerRadius="12"
                                        Padding="14,10"
                                        MaxWidth="480"
                                        HorizontalAlignment="Left"
                                        Background="{StaticResource Surface0Brush}">
                                    <StackPanel>
                                        <TextBlock x:Name="TimeLabel"
                                                   Text="{Binding TimeDisplay}"
                                                   FontSize="10"
                                                   Foreground="{StaticResource Overlay0Brush}"
                                                   Margin="0,0,0,3"/>
                                        <!--
                                            Message body
                                            - Default: lightweight Markdown-ish rendering (bold + bullets) via FlowDocument.
                                            - Tool/status messages: fall back to plain TextBox for tight control over styling.
                                        -->
                                        <FlowDocumentScrollViewer x:Name="ContentMarkdown"
                                                                 Document="{Binding Content, Converter={StaticResource MarkdownToFlowDocument}}"
                                                                 FontSize="13"
                                                                 FontFamily="Segoe UI"
                                                                 Foreground="{StaticResource TextBrush}"
                                                                 Background="Transparent"
                                                                 FocusVisualStyle="{x:Null}"
                                                                 IsTabStop="False"
                                                                 IsSelectionEnabled="True"
                                                                 VerticalScrollBarVisibility="Hidden"
                                                                 HorizontalScrollBarVisibility="Hidden"/>

                                        <TextBox x:Name="ContentPlain"
                                                 Text="{Binding Content, Mode=OneWay}"
                                                 Visibility="Collapsed"
                                                 TextWrapping="Wrap"
                                                 FontSize="13"
                                                 FontFamily="Segoe UI"
                                                 Foreground="{StaticResource TextBrush}"
                                                 Background="Transparent"
                                                 BorderThickness="0"
                                                 Padding="0"
                                                 IsReadOnly="True"
                                                 IsReadOnlyCaretVisible="False"
                                                 IsTabStop="False"
                                                 FocusVisualStyle="{x:Null}"
                                                 Cursor="IBeam"
                                                 SelectionBrush="{StaticResource BlueBrush}"
                                                 SelectionOpacity="0.35"
                                                 CaretBrush="{StaticResource TextBrush}"/>

                                        <!-- ══════════════════════════════════════
                                             SOURCE CARDS CAROUSEL
                                             ViewModel-driven paging — shows 2
                                             cards at a time, arrows swap pages.
                                             No ScrollViewer, no jank.
                                             ══════════════════════════════════ -->
                                        <Grid x:Name="SourceCardsPanel"
                                              Visibility="Collapsed"
                                              Margin="0,12,0,4">
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                            </Grid.RowDefinitions>

                                            <!-- ── Left arrow (overlaid) ──────── -->
                                            <Button Grid.Row="0"
                                                    Command="{Binding PrevPageCommand}"
                                                    VerticalAlignment="Center"
                                                    HorizontalAlignment="Left"
                                                    Panel.ZIndex="10"
                                                    Cursor="Hand"
                                                    Width="30" Height="30"
                                                    Margin="-4,0,0,0">
                                                <Button.Style>
                                                    <Style TargetType="Button">
                                                        <Setter Property="Visibility" Value="Visible"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding CanGoLeft}" Value="False">
                                                                <Setter Property="Visibility" Value="Hidden"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Button.Style>
                                                <Button.Template>
                                                    <ControlTemplate TargetType="Button">
                                                        <Border x:Name="ArrowBg"
                                                                Background="#DD1E1E2E"
                                                                CornerRadius="15"
                                                                Width="30" Height="30">
                                                            <TextBlock Text="&#x276E;"
                                                                       FontSize="14"
                                                                       Foreground="{StaticResource TextBrush}"
                                                                       HorizontalAlignment="Center"
                                                                       VerticalAlignment="Center"/>
                                                        </Border>
                                                        <ControlTemplate.Triggers>
                                                            <Trigger Property="IsMouseOver" Value="True">
                                                                <Setter TargetName="ArrowBg"
                                                                        Property="Background" Value="#EE45475A"/>
                                                            </Trigger>
                                                        </ControlTemplate.Triggers>
                                                    </ControlTemplate>
                                                </Button.Template>
                                            </Button>

                                            <!-- ── Right arrow (overlaid) ─────── -->
                                            <Button Grid.Row="0"
                                                    Command="{Binding NextPageCommand}"
                                                    VerticalAlignment="Center"
                                                    HorizontalAlignment="Right"
                                                    Panel.ZIndex="10"
                                                    Cursor="Hand"
                                                    Width="30" Height="30"
                                                    Margin="0,0,-4,0">
                                                <Button.Style>
                                                    <Style TargetType="Button">
                                                        <Setter Property="Visibility" Value="Visible"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding CanGoRight}" Value="False">
                                                                <Setter Property="Visibility" Value="Hidden"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Button.Style>
                                                <Button.Template>
                                                    <ControlTemplate TargetType="Button">
                                                        <Border x:Name="ArrowBg"
                                                                Background="#DD1E1E2E"
                                                                CornerRadius="15"
                                                                Width="30" Height="30">
                                                            <TextBlock Text="&#x276F;"
                                                                       FontSize="14"
                                                                       Foreground="{StaticResource TextBrush}"
                                                                       HorizontalAlignment="Center"
                                                                       VerticalAlignment="Center"/>
                                                        </Border>
                                                        <ControlTemplate.Triggers>
                                                            <Trigger Property="IsMouseOver" Value="True">
                                                                <Setter TargetName="ArrowBg"
                                                                        Property="Background" Value="#EE45475A"/>
                                                            </Trigger>
                                                        </ControlTemplate.Triggers>
                                                    </ControlTemplate>
                                                </Button.Template>
                                            </Button>

                                            <!-- ── Card row (2 per page, ViewModel-driven) ── -->
                                            <ItemsControl Grid.Row="0"
                                                          ItemsSource="{Binding VisibleCards}"
                                                          Margin="10,0,10,0">
                                                <ItemsControl.ItemsPanel>
                                                    <ItemsPanelTemplate>
                                                        <StackPanel Orientation="Horizontal"/>
                                                    </ItemsPanelTemplate>
                                                </ItemsControl.ItemsPanel>
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <!-- ── Clickable Source Card ────── -->
                                                        <Button Click="SourceCard_Click"
                                                                Cursor="Hand"
                                                                Margin="0,0,10,0"
                                                                VerticalAlignment="Top"
                                                                Opacity="0"
                                                                RenderTransformOrigin="0,0.5">
                                                            <!-- Slide+fade entrance on page swap -->
                                                            <Button.RenderTransform>
                                                                <TranslateTransform/>
                                                            </Button.RenderTransform>
                                                            <Button.Triggers>
                                                                <EventTrigger RoutedEvent="FrameworkElement.Loaded">
                                                                    <BeginStoryboard>
                                                                        <Storyboard>
                                                                            <DoubleAnimation
                                                                                Storyboard.TargetProperty="Opacity"
                                                                                From="0" To="1"
                                                                                Duration="0:0:0.28"/>
                                                                            <DoubleAnimation
                                                                                Storyboard.TargetProperty="(UIElement.RenderTransform).(TranslateTransform.X)"
                                                                                From="40" To="0"
                                                                                Duration="0:0:0.3">
                                                                                <DoubleAnimation.EasingFunction>
                                                                                    <CubicEase EasingMode="EaseOut"/>
                                                                                </DoubleAnimation.EasingFunction>
                                                                            </DoubleAnimation>
                                                                        </Storyboard>
                                                                    </BeginStoryboard>
                                                                </EventTrigger>
                                                            </Button.Triggers>
                                                            <Button.Template>
                                                                <ControlTemplate TargetType="Button">
                                                                    <Border x:Name="CardBorder"
                                                                            Background="{StaticResource Surface1Brush}"
                                                                            CornerRadius="10"
                                                                            Width="198"
                                                                            ClipToBounds="True"
                                                                            SnapsToDevicePixels="True">
                                                                        <StackPanel>
                                                                            <!-- ── Thumbnail image area ──── -->
                                                                            <Grid Height="110"
                                                                                  Background="{StaticResource Surface0Brush}">
                                                                                <Image x:Name="ThumbnailImg"
                                                                                       Source="{Binding ThumbnailUrl,
                                                                                                Converter={StaticResource UrlToImage}}"
                                                                                       Stretch="UniformToFill"
                                                                                       HorizontalAlignment="Center"
                                                                                       VerticalAlignment="Center"
                                                                                       Visibility="Collapsed"/>

                                                                                <Border x:Name="ThumbPlaceholder"
                                                                                        Background="{Binding AvatarColor,
                                                                                                     Converter={StaticResource StringToBrush}}">
                                                                                    <TextBlock Text="{Binding AvatarLetter}"
                                                                                               FontSize="32"
                                                                                               FontWeight="Bold"
                                                                                               Foreground="#11111B"
                                                                                               Opacity="0.35"
                                                                                               HorizontalAlignment="Center"
                                                                                               VerticalAlignment="Center"/>
                                                                                </Border>
                                                                            </Grid>

                                                                            <!-- ── Card body ──────────────── -->
                                                                            <StackPanel Margin="12,8,12,10">
                                                                                <!-- Domain + favicon row -->
                                                                                <Grid Height="18" Margin="0,0,0,5">
                                                                                    <Grid.ColumnDefinitions>
                                                                                        <ColumnDefinition Width="18"/>
                                                                                        <ColumnDefinition Width="*"/>
                                                                                    </Grid.ColumnDefinitions>

                                                                                    <Image x:Name="FaviconImg"
                                                                                           Grid.Column="0"
                                                                                           Source="{Binding FaviconBase64,
                                                                                                    Converter={StaticResource Base64ToImage}}"
                                                                                           Width="14" Height="14"
                                                                                           HorizontalAlignment="Center"
                                                                                           VerticalAlignment="Center"
                                                                                           Visibility="Collapsed"/>

                                                                                    <Border x:Name="AvatarCircle"
                                                                                            Grid.Column="0"
                                                                                            Width="16" Height="16"
                                                                                            CornerRadius="8"
                                                                                            HorizontalAlignment="Center"
                                                                                            VerticalAlignment="Center"
                                                                                            Background="{Binding AvatarColor,
                                                                                                         Converter={StaticResource StringToBrush}}">
                                                                                        <TextBlock Text="{Binding AvatarLetter}"
                                                                                                   FontSize="8"
                                                                                                   FontWeight="Bold"
                                                                                                   Foreground="#11111B"
                                                                                                   HorizontalAlignment="Center"
                                                                                                   VerticalAlignment="Center"/>
                                                                                    </Border>

                                                                                    <TextBlock Grid.Column="1"
                                                                                               Text="{Binding Domain}"
                                                                                               FontSize="10.5"
                                                                                               Foreground="{StaticResource Overlay0Brush}"
                                                                                               VerticalAlignment="Center"
                                                                                               Margin="5,0,0,0"
                                                                                               TextTrimming="CharacterEllipsis"/>
                                                                                </Grid>

                                                                                <!-- Title -->
                                                                                <TextBlock Text="{Binding Title}"
                                                                                           FontSize="12.5"
                                                                                           FontWeight="SemiBold"
                                                                                           Foreground="{StaticResource TextBrush}"
                                                                                           TextWrapping="Wrap"
                                                                                           MaxHeight="36"
                                                                                           TextTrimming="CharacterEllipsis"
                                                                                           Margin="0,0,0,4"/>

                                                                                <!-- Excerpt / summary -->
                                                                                <TextBlock Text="{Binding Excerpt}"
                                                                                           FontSize="11"
                                                                                           Foreground="{StaticResource Subtext0Brush}"
                                                                                           TextWrapping="Wrap"
                                                                                           MaxHeight="64"
                                                                                           TextTrimming="CharacterEllipsis"
                                                                                           LineHeight="15"/>
                                                                            </StackPanel>
                                                                        </StackPanel>
                                                                    </Border>

                                                                    <ControlTemplate.Triggers>
                                                                        <Trigger Property="IsMouseOver" Value="True">
                                                                            <Setter TargetName="CardBorder"
                                                                                    Property="Background"
                                                                                    Value="{StaticResource Surface2Brush}"/>
                                                                        </Trigger>
                                                                        <DataTrigger Binding="{Binding HasThumbnail}" Value="True">
                                                                            <Setter TargetName="ThumbnailImg"
                                                                                    Property="Visibility" Value="Visible"/>
                                                                            <Setter TargetName="ThumbPlaceholder"
                                                                                    Property="Visibility" Value="Collapsed"/>
                                                                        </DataTrigger>
                                                                        <DataTrigger Binding="{Binding HasFavicon}" Value="True">
                                                                            <Setter TargetName="FaviconImg"
                                                                                    Property="Visibility" Value="Visible"/>
                                                                            <Setter TargetName="AvatarCircle"
                                                                                    Property="Visibility" Value="Collapsed"/>
                                                                        </DataTrigger>
                                                                    </ControlTemplate.Triggers>
                                                                </ControlTemplate>
                                                            </Button.Template>
                                                        </Button>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>

                                            <!-- ── Page indicator (e.g. "1 / 3") ── -->
                                            <TextBlock Grid.Row="1"
                                                       Text="{Binding CarouselPageLabel}"
                                                       FontSize="11"
                                                       Foreground="{StaticResource Overlay0Brush}"
                                                       HorizontalAlignment="Center"
                                                       Margin="0,6,0,0"/>
                                        </Grid>
                                    </StackPanel>
                                </Border>
                            </Grid>

                            <DataTemplate.Triggers>
                                <!-- ── Show source cards when present ──────── -->
                                <DataTrigger Binding="{Binding HasSourceCards}" Value="True">
                                    <Setter TargetName="SourceCardsPanel"
                                            Property="Visibility" Value="Visible"/>
                                </DataTrigger>

                                <!-- ── User: right-aligned accent bubble ──── -->
                                <DataTrigger Binding="{Binding IsUser}" Value="True">
                                    <Setter TargetName="Bubble"
                                            Property="HorizontalAlignment" Value="Right"/>
                                    <Setter TargetName="Bubble"
                                            Property="Background"
                                            Value="{StaticResource BlueBrush}"/>
                                    <Setter TargetName="ContentMarkdown"
                                            Property="Foreground"
                                            Value="{StaticResource CrustBrush}"/>
                                    <Setter TargetName="ContentMarkdown"
                                            Property="FontWeight" Value="Medium"/>
                                    <Setter TargetName="ContentPlain"
                                            Property="Foreground"
                                            Value="{StaticResource CrustBrush}"/>
                                    <Setter TargetName="ContentPlain"
                                            Property="FontWeight" Value="Medium"/>
                                    <Setter TargetName="TimeLabel"
                                            Property="Foreground" Value="#45475A"/>
                                    <Setter TargetName="TimeLabel"
                                            Property="HorizontalAlignment" Value="Right"/>
                                    <Setter TargetName="SourceCardsPanel"
                                            Property="Visibility" Value="Collapsed"/>
                                </DataTrigger>

                                <!-- ── Tool activity: subtle bordered ─────── -->
                                <DataTrigger Binding="{Binding IsToolActivity}" Value="True">
                                    <Setter TargetName="Bubble"
                                            Property="Background"
                                            Value="{StaticResource MantleBrush}"/>
                                    <Setter TargetName="Bubble"
                                            Property="BorderBrush"
                                            Value="{StaticResource Surface1Brush}"/>
                                    <Setter TargetName="Bubble"
                                            Property="BorderThickness" Value="1"/>
                                    <Setter TargetName="ContentMarkdown"
                                            Property="Visibility" Value="Collapsed"/>
                                    <Setter TargetName="ContentPlain"
                                            Property="Visibility" Value="Visible"/>
                                    <Setter TargetName="ContentPlain"
                                            Property="FontSize" Value="11"/>
                                    <Setter TargetName="ContentPlain"
                                            Property="Foreground"
                                            Value="{StaticResource Subtext0Brush}"/>
                                    <Setter TargetName="TimeLabel"
                                            Property="Visibility" Value="Collapsed"/>
                                    <Setter TargetName="SourceCardsPanel"
                                            Property="Visibility" Value="Collapsed"/>
                                </DataTrigger>

                                <!-- ── Status: centered, no bubble ────────── -->
                                <DataTrigger Binding="{Binding IsStatus}" Value="True">
                                    <Setter TargetName="Bubble"
                                            Property="HorizontalAlignment" Value="Stretch"/>
                                    <Setter TargetName="Bubble"
                                            Property="Background" Value="Transparent"/>
                                    <Setter TargetName="Bubble"
                                            Property="MaxWidth" Value="9999"/>
                                    <Setter TargetName="ContentMarkdown"
                                            Property="Visibility" Value="Collapsed"/>
                                    <Setter TargetName="ContentPlain"
                                            Property="Visibility" Value="Visible"/>
                                    <Setter TargetName="ContentPlain"
                                            Property="HorizontalAlignment" Value="Center"/>
                                    <Setter TargetName="ContentPlain"
                                            Property="TextAlignment" Value="Center"/>
                                    <Setter TargetName="ContentPlain"
                                            Property="FontStyle" Value="Italic"/>
                                    <Setter TargetName="ContentPlain"
                                            Property="FontSize" Value="12"/>
                                    <Setter TargetName="ContentPlain"
                                            Property="Foreground"
                                            Value="{StaticResource Overlay0Brush}"/>
                                    <Setter TargetName="TimeLabel"
                                            Property="Visibility" Value="Collapsed"/>
                                    <Setter TargetName="SourceCardsPanel"
                                            Property="Visibility" Value="Collapsed"/>
                                </DataTrigger>
                            </DataTemplate.Triggers>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>

            <!-- ── Splitter ────────────────────────────────────────── -->
            <GridSplitter Grid.Column="1"
                          Width="1"
                          Background="{StaticResource Surface0Brush}"
                          HorizontalAlignment="Center"
                          VerticalAlignment="Stretch"
                          ResizeBehavior="PreviousAndNext"/>

            <!-- ── Right: Activity Log ─────────────────────────────── -->
            <Grid Grid.Column="2"
                  Background="{StaticResource CrustBrush}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Log header -->
                <Border Grid.Row="0"
                        Background="{StaticResource CrustBrush}"
                        Padding="12,8"
                        BorderBrush="{StaticResource Surface0Brush}"
                        BorderThickness="0,0,0,1">
                    <TextBlock Text="Activity Log"
                               FontSize="11"
                               FontWeight="SemiBold"
                               Foreground="{StaticResource Overlay0Brush}"/>
                </Border>

                <!-- Log entries -->
                <ScrollViewer Grid.Row="1"
                              x:Name="LogScroller"
                              VerticalScrollBarVisibility="Auto"
                              HorizontalScrollBarVisibility="Disabled">
                    <ItemsControl ItemsSource="{Binding ActivityLog}"
                                  Padding="8,4">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Grid Margin="0,1">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>

                                    <!-- Timestamp -->
                                    <TextBlock Grid.Column="0"
                                               Text="{Binding TimeDisplay}"
                                               FontFamily="Cascadia Mono, Consolas, monospace"
                                               FontSize="10"
                                               Foreground="{StaticResource Surface2Brush}"
                                               Margin="0,0,8,0"
                                               VerticalAlignment="Top"/>

                                    <!-- Log text -->
                                    <TextBlock x:Name="LogText"
                                               Grid.Column="1"
                                               Text="{Binding Text}"
                                               TextWrapping="Wrap"
                                               FontFamily="Cascadia Mono, Consolas, monospace"
                                               FontSize="11"
                                               Foreground="{StaticResource Subtext0Brush}"/>
                                </Grid>

                                <DataTemplate.Triggers>
                                    <DataTrigger Binding="{Binding IsToolInput}" Value="True">
                                        <Setter TargetName="LogText"
                                                Property="Foreground"
                                                Value="{StaticResource TealBrush}"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding IsToolOutput}" Value="True">
                                        <Setter TargetName="LogText"
                                                Property="Foreground"
                                                Value="{StaticResource PeachBrush}"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding IsError}" Value="True">
                                        <Setter TargetName="LogText"
                                                Property="Foreground"
                                                Value="{StaticResource RedBrush}"/>
                                    </DataTrigger>
                                </DataTemplate.Triggers>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </Grid>
        </Grid>

        <!-- ═══════════════════════════════════════════════════════════
             INPUT AREA
             ═══════════════════════════════════════════════════════ -->
        <Border Grid.Row="2"
                Background="{StaticResource MantleBrush}"
                Padding="12"
                BorderBrush="{StaticResource Surface0Brush}"
                BorderThickness="0,1,0,0">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <TextBox Grid.Column="0"
                         x:Name="ChatInput"
                         Style="{StaticResource ChatInputStyle}"
                         Text="{Binding InputText, UpdateSourceTrigger=PropertyChanged}"
                         Margin="0,0,8,0"/>

                <!-- Send / Cancel button swap -->
                <Grid Grid.Column="1">
                    <!-- Send (visible when NOT processing) -->
                    <Button Content="Send ↵"
                            Command="{Binding SendCommand}">
                        <Button.Style>
                            <Style TargetType="Button"
                                   BasedOn="{StaticResource SendButtonStyle}">
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsProcessing}"
                                                 Value="True">
                                        <Setter Property="Visibility"
                                                Value="Collapsed"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                    </Button>

                    <!-- Cancel (visible when processing) -->
                    <Button Content="Cancel"
                            Command="{Binding CancelCommand}"
                            Visibility="{Binding IsProcessing,
                                         Converter={StaticResource BoolToVis}}"
                            Style="{StaticResource CancelButtonStyle}"/>
                </Grid>
            </Grid>
        </Border>
    </Grid>
</Window>
